"use strict";

require("source-map-support/register");

var _core = require("@electron-forge/core");

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _commander = _interopRequireDefault(require("commander"));

var _path = _interopRequireDefault(require("path"));

require("./util/terminate");

var _workingDir = _interopRequireDefault(require("./util/working-dir"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

(async () => {
  let commandArgs = process.argv;
  let appArgs;
  const doubleDashIndex = process.argv.indexOf('--');

  if (doubleDashIndex !== -1) {
    commandArgs = process.argv.slice(0, doubleDashIndex);
    appArgs = process.argv.slice(doubleDashIndex + 1);
  }

  let dir = process.cwd();

  _commander.default.version((await _fsExtra.default.readJson(_path.default.resolve(__dirname, '../package.json'))).version).arguments('[cwd]').option('-p, --app-path <path>', 'Override the path to the Electron app to launch (defaults to \'.\')').option('-l, --enable-logging', 'Enable advanced logging.  This will log internal Electron things').option('-n, --run-as-node', 'Run the Electron app as a Node.JS script').option('--vscode', 'Used to enable arg transformation for debugging Electron through VSCode.  Do not use yourself.').option('-i, --inspect-electron', 'Triggers inspect mode on Electron to allow debugging the main process.  Electron >1.7 only').action(cwd => {
    dir = (0, _workingDir.default)(dir, cwd);
  }).parse(commandArgs);

  _commander.default.on('--help', () => {
    console.log('  Any arguments found after "--" will be passed to the Electron app, e.g.');
    console.log('');
    console.log('    $ electron-forge /path/to/project -l -- -d -f foo.txt');
    console.log('');
    console.log('  will pass the arguments "-d -f foo.txt" to the Electron app');
  });

  const opts = {
    dir,
    interactive: true,
    enableLogging: !!_commander.default.enableLogging,
    runAsNode: !!_commander.default.runAsNode,
    inspect: !!_commander.default.inspectElectron
  };

  if (_commander.default.vscode && appArgs) {
    // Args are in the format ~arg~ so we need to strip the "~"
    appArgs = appArgs.map(arg => arg.substr(1, arg.length - 2)).filter(arg => arg.length > 0);
  }

  if (_commander.default.appPath) opts.appPath = _commander.default.appPath;
  if (appArgs) opts.args = appArgs;
  const spawned = await _core.api.start(opts);
  await new Promise(resolve => {
    const listenForExit = child => {
      let onExit;
      let onRestart;

      const removeListeners = () => {
        child.removeListener('exit', onExit);
        child.removeListener('restarted', onRestart);
      };

      onExit = code => {
        removeListeners();
        if (spawned.restarted) return;

        if (code !== 0) {
          process.exit(code);
        }

        resolve();
      };

      onRestart = newChild => {
        removeListeners();
        listenForExit(newChild);
      };

      child.on('exit', onExit);
      child.on('restarted', onRestart);
    };

    listenForExit(spawned);
  });
})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9lbGVjdHJvbi1mb3JnZS1zdGFydC50cyJdLCJuYW1lcyI6WyJjb21tYW5kQXJncyIsInByb2Nlc3MiLCJhcmd2IiwiYXBwQXJncyIsImRvdWJsZURhc2hJbmRleCIsImluZGV4T2YiLCJzbGljZSIsImRpciIsImN3ZCIsInByb2dyYW0iLCJ2ZXJzaW9uIiwiZnMiLCJyZWFkSnNvbiIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiYXJndW1lbnRzIiwib3B0aW9uIiwiYWN0aW9uIiwicGFyc2UiLCJvbiIsImNvbnNvbGUiLCJsb2ciLCJvcHRzIiwiaW50ZXJhY3RpdmUiLCJlbmFibGVMb2dnaW5nIiwicnVuQXNOb2RlIiwiaW5zcGVjdCIsImluc3BlY3RFbGVjdHJvbiIsInZzY29kZSIsIm1hcCIsImFyZyIsInN1YnN0ciIsImxlbmd0aCIsImZpbHRlciIsImFwcFBhdGgiLCJhcmdzIiwic3Bhd25lZCIsImFwaSIsInN0YXJ0IiwiUHJvbWlzZSIsImxpc3RlbkZvckV4aXQiLCJjaGlsZCIsIm9uRXhpdCIsIm9uUmVzdGFydCIsInJlbW92ZUxpc3RlbmVycyIsInJlbW92ZUxpc3RlbmVyIiwiY29kZSIsInJlc3RhcnRlZCIsImV4aXQiLCJuZXdDaGlsZCJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBOztBQUdBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOzs7O0FBRUEsQ0FBQyxZQUFZO0FBQ1gsTUFBSUEsV0FBVyxHQUFHQyxPQUFPLENBQUNDLElBQTFCO0FBQ0EsTUFBSUMsT0FBSjtBQUVBLFFBQU1DLGVBQWUsR0FBR0gsT0FBTyxDQUFDQyxJQUFSLENBQWFHLE9BQWIsQ0FBcUIsSUFBckIsQ0FBeEI7O0FBQ0EsTUFBSUQsZUFBZSxLQUFLLENBQUMsQ0FBekIsRUFBNEI7QUFDMUJKLElBQUFBLFdBQVcsR0FBR0MsT0FBTyxDQUFDQyxJQUFSLENBQWFJLEtBQWIsQ0FBbUIsQ0FBbkIsRUFBc0JGLGVBQXRCLENBQWQ7QUFDQUQsSUFBQUEsT0FB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QSxPQUFPLENBQUNnRCxJQUFSLENBQWFGLElBQWI7QUFDRDs7QUFDRGpDLFFBQUFBLE9BQU87QUFDUixPQVBEOztBQVFBOEIsTUFBQUEsU0FBUyxHQUFJTSxRQUFELElBQTRCO0FBQ3RDTCxRQUFBQSxlQUFlO0FBQ2ZKLFFBQUFBLGFBQWEsQ0FBQ1MsUUFBRCxDQUFiO0FBQ0QsT0FIRDs7QUFJQVIsTUFBQUEsS0FBSyxDQUFDdEIsRUFBTixDQUFTLE1BQVQsRUFBaUJ1QixNQUFqQjtBQUNBRCxNQUFBQSxLQUFLLENBQUN0QixFQUFOLENBQVMsV0FBVCxFQUFzQndCLFNBQXRCO0FBQ0QsS0FyQkQ7O0FBc0JBSCxJQUFBQSxhQUFhLENBQUNKLE9BQUQsQ0FBYjtBQUNELEdBeEJLLENBQU47QUF5QkQsQ0EzRUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBhcGksIFN0YXJ0T3B0aW9ucyB9IGZyb20gJ0BlbGVjdHJvbi1mb3JnZS9jb3JlJztcblxuaW1wb3J0IHsgQ2hpbGRQcm9jZXNzIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHByb2dyYW0gZnJvbSAnY29tbWFuZGVyJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuXG5pbXBvcnQgJy4vdXRpbC90ZXJtaW5hdGUnO1xuaW1wb3J0IHdvcmtpbmdEaXIgZnJvbSAnLi91dGlsL3dvcmtpbmctZGlyJztcblxuKGFzeW5jICgpID0+IHtcbiAgbGV0IGNvbW1hbmRBcmdzID0gcHJvY2Vzcy5hcmd2O1xuICBsZXQgYXBwQXJncztcblxuICBjb25zdCBkb3VibGVEYXNoSW5kZXggPSBwcm9jZXNzLmFyZ3YuaW5kZXhPZignLS0nKTtcbiAgaWYgKGRvdWJsZURhc2hJbmRleCAhPT0gLTEpIHtcbiAgICBjb21tYW5kQXJncyA9IHByb2Nlc3MuYXJndi5zbGljZSgwLCBkb3VibGVEYXNoSW5kZXgpO1xuICAgIGFwcEFyZ3MgPSBwcm9jZXNzLmFyZ3Yuc2xpY2UoZG91YmxlRGFzaEluZGV4ICsgMSk7XG4gIH1cblxuICBsZXQgZGlyID0gcHJvY2Vzcy5jd2QoKTtcbiAgcHJvZ3JhbVxuICAgIC52ZXJzaW9uKChhd2FpdCBmcy5yZWFkSnNvbihwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vcGFja2FnZS5qc29uJykpKS52ZXJzaW9uKVxuICAgIC5hcmd1bWVudHMoJ1tjd2RdJylcbiAgICAub3B0aW9uKCctcCwgLS1hcHAtcGF0aCA8cGF0aD4nLCAnT3ZlcnJpZGUgdGhlIHBhdGggdG8gdGhlIEVsZWN0cm9uIGFwcCB0byBsYXVuY2ggKGRlZmF1bHRzIHRvIFxcJy5cXCcpJylcbiAgICAub3B0aW9uKCctbCwgLS1lbmFibGUtbG9nZ2luZycsICdFbmFibGUgYWR2YW5jZWQgbG9nZ2luZy4gIFRoaXMgd2lsbCBsb2cgaW50ZXJuYWwgRWxlY3Ryb24gdGhpbmdzJylcbiAgICAub3B0aW9uKCctbiwgLS1ydW4tYXMtbm9kZScsICdSdW4gdGhlIEVsZWN0cm9uIGFwcCBhcyBhIE5vZGUuSlMgc2NyaXB0JylcbiAgICAub3B0aW9uKCctLXZzY29kZScsICdVc2VkIHRvIGVuYWJsZSBhcmcgdHJhbnNmb3JtYXRpb24gZm9yIGRlYnVnZ2luZyBFbGVjdHJvbiB0aHJvdWdoIFZTQ29kZS4gIERvIG5vdCB1c2UgeW91cnNlbGYuJylcbiAgICAub3B0aW9uKCctaSwgLS1pbnNwZWN0LWVsZWN0cm9uJywgJ1RyaWdnZXJzIGluc3BlY3QgbW9kZSBvbiBFbGVjdHJvbiB0byBhbGxvdyBkZWJ1Z2dpbmcgdGhlIG1haW4gcHJvY2Vzcy4gIEVsZWN0cm9uID4xLjcgb25seScpXG4gICAgLmFjdGlvbigoY3dkKSA9PiB7IGRpciA9IHdvcmtpbmdEaXIoZGlyLCBjd2QpOyB9KVxuICAgIC5wYXJzZShjb21tYW5kQXJncyk7XG5cbiAgcHJvZ3JhbS5vbignLS1oZWxwJywgKCkgPT4ge1xuICAgIGNvbnNvbGUubG9nKCcgIEFueSBhcmd1bWVudHMgZm91bmQgYWZ0ZXIgXCItLVwiIHdpbGwgYmUgcGFzc2VkIHRvIHRoZSBFbGVjdHJvbiBhcHAsIGUuZy4nKTtcbiAgICBjb25zb2xlLmxvZygnJyk7XG4gICAgY29uc29sZS5sb2coJyAgICAkIGVsZWN0cm9uLWZvcmdlIC9wYXRoL3RvL3Byb2plY3QgLWwgLS0gLWQgLWYgZm9vLnR4dCcpO1xuICAgIGNvbnNvbGUubG9nKCcnKTtcbiAgICBjb25zb2xlLmxvZygnICB3aWxsIHBhc3MgdGhlIGFyZ3VtZW50cyBcIi1kIC1mIGZvby50eHRcIiB0byB0aGUgRWxlY3Ryb24gYXBwJyk7XG4gIH0pO1xuXG4gIGNvbnN0IG9wdHM6IFN0YXJ0T3B0aW9ucyA9IHtcbiAgICBkaXIsXG4gICAgaW50ZXJhY3RpdmU6IHRydWUsXG4gICAgZW5hYmxlTG9nZ2luZzogISFwcm9ncmFtLmVuYWJsZUxvZ2dpbmcsXG4gICAgcnVuQXNOb2RlOiAhIXByb2dyYW0ucnVuQXNOb2RlLFxuICAgIGluc3BlY3Q6ICEhcHJvZ3JhbS5pbnNwZWN0RWxlY3Ryb24sXG4gIH07XG5cbiAgaWYgKHByb2dyYW0udnNjb2RlICYmIGFwcEFyZ3MpIHtcbiAgICAvLyBBcmdzIGFyZSBpbiB0aGUgZm9ybWF0IH5hcmd+IHNvIHdlIG5lZWQgdG8gc3RyaXAgdGhlIFwiflwiXG4gICAgYXBwQXJncyA9IGFwcEFyZ3NcbiAgICAgIC5tYXAoKGFyZykgPT4gYXJnLnN1YnN0cigxLCBhcmcubGVuZ3RoIC0gMikpXG4gICAgICAuZmlsdGVyKChhcmcpID0+IGFyZy5sZW5ndGggPiAwKTtcbiAgfVxuXG4gIGlmIChwcm9ncmFtLmFwcFBhdGgpIG9wdHMuYXBwUGF0aCA9IHByb2dyYW0uYXBwUGF0aDtcbiAgaWYgKGFwcEFyZ3MpIG9wdHMuYXJncyA9IGFwcEFyZ3M7XG5cbiAgY29uc3Qgc3Bhd25lZCA9IGF3YWl0IGFwaS5zdGFydChvcHRzKTtcblxuICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgIGNvbnN0IGxpc3RlbkZvckV4aXQgPSAoY2hpbGQ6IENoaWxkUHJvY2VzcykgPT4ge1xuICAgICAgbGV0IG9uRXhpdDogTm9kZUpTLkV4aXRMaXN0ZW5lcjtcbiAgICAgIGxldCBvblJlc3RhcnQ6IChuZXdDaGlsZDogQ2hpbGRQcm9jZXNzKSA9PiB2b2lkO1xuICAgICAgY29uc3QgcmVtb3ZlTGlzdGVuZXJzID0gKCkgPT4ge1xuICAgICAgICBjaGlsZC5yZW1vdmVMaXN0ZW5lcignZXhpdCcsIG9uRXhpdCk7XG4gICAgICAgIGNoaWxkLnJlbW92ZUxpc3RlbmVyKCdyZXN0YXJ0ZWQnLCBvblJlc3RhcnQpO1xuICAgICAgfTtcbiAgICAgIG9uRXhpdCA9IChjb2RlOiBudW1iZXIpID0+IHtcbiAgICAgICAgcmVtb3ZlTGlzdGVuZXJzKCk7XG4gICAgICAgIGlmICgoc3Bhd25lZCBhcyBhbnkpLnJlc3RhcnRlZCkgcmV0dXJuO1xuICAgICAgICBpZiAoY29kZSAhPT0gMCkge1xuICAgICAgICAgIHByb2Nlc3MuZXhpdChjb2RlKTtcbiAgICAgICAgfVxuICAgICAgICByZXNvbHZlKCk7XG4gICAgICB9O1xuICAgICAgb25SZXN0YXJ0ID0gKG5ld0NoaWxkOiBDaGlsZFByb2Nlc3MpID0+IHtcbiAgICAgICAgcmVtb3ZlTGlzdGVuZXJzKCk7XG4gICAgICAgIGxpc3RlbkZvckV4aXQobmV3Q2hpbGQpO1xuICAgICAgfTtcbiAgICAgIGNoaWxkLm9uKCdleGl0Jywgb25FeGl0KTtcbiAgICAgIGNoaWxkLm9uKCdyZXN0YXJ0ZWQnLCBvblJlc3RhcnQpO1xuICAgIH07XG4gICAgbGlzdGVuRm9yRXhpdChzcGF3bmVkIGFzIENoaWxkUHJvY2Vzcyk7XG4gIH0pO1xufSkoKTtcbiJdfQ==