"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

require("colors");

var _asyncOra = require("@electron-forge/async-ora");

var _installerBase = _interopRequireDefault(require("@electron-forge/installer-base"));

var _debug = _interopRequireDefault(require("debug"));

var _nodeFetch = _interopRequireDefault(require("node-fetch"));

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _os = _interopRequireDefault(require("os"));

var _path = _interopRequireDefault(require("path"));

var _util = require("util");

var _semver = _interopRequireDefault(require("semver"));

var _installerDmg = _interopRequireDefault(require("@electron-forge/installer-dmg"));

var _installerZip = _interopRequireDefault(require("@electron-forge/installer-zip"));

var _installerDeb = _interopRequireDefault(require("@electron-forge/installer-deb"));

var _installerRpm = _interopRequireDefault(require("@electron-forge/installer-rpm"));

var _installerExe = _interopRequireDefault(require("@electron-forge/installer-exe"));

var _messages = require("../util/messages");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const nugget = require('nugget');

const d = (0, _debug.default)('electron-forge:install');
const GITHUB_API = 'https://api.github.com';

class InstallerImpl extends _installerBase.default {
  constructor(...args) {
    super(...args);

    _defineProperty(this, "name", 'impl');
  }

}

var _default = async ({
  interactive = false,
  prerelease = false,
  repo,
  chooseAsset
}) => {
  _asyncOra.asyncOra.interactive = interactive;

  if (typeof chooseAsset !== 'function') {
    throw new Error('Expected chooseAsset to be a function in install call');
  }

  let latestRelease;
  let possibleAssets = [];
  await (0, _asyncOra.asyncOra)('Searching for Application', async searchSpinner => {
    if (!repo || repo.indexOf('/') === -1) {
      throw new Error('Invalid repository name, must be in the format owner/name');
    }

    d('searching for repo:', repo);
    let releases;

    try {
      releases = await (await (0, _nodeFetch.default)(`${GITHUB_API}/repos/${repo}/releases`)).json();
    } catch (err) {// Ignore error
    }

    if (!releases || releases.message === 'Not Found' || !Array.isArray(releases)) {
      throw new Error(`Failed to find releases for repository "${repo}".  Please check the name and try again.`);
    }

    if (releases.length === 0) {
      throw new Error(`Repository "${repo}" has no releases`);
    }

    releases = releases.filter(release => !release.prerelease || prerelease);
    const sortedReleases = releases.sort((releaseA, releaseB) => {
      let tagA = releaseA.tag_name;
      if (tagA.substr(0, 1) === 'v') tagA = tagA.substr(1);
      let tagB = releaseB.tag_name;
      if (tagB.substr(0, 1) === 'v') tagB = tagB.substr(1);
      return _semver.default.gt(tagB, tagA) ? 1 : -1;
    }); // eslint-disable-next-line prefer-destructuring

    latestRelease = sortedReleases[0];
    searchSpinner.text = 'Searching for Releases';
    const {
      assets
    } = latestRelease;

    if (!assets || !Array.isArray(assets) || assets.length === 0) {
      throw new Error('Could not find any assets for the latest release');
    }

    const installTargets = {
      win32: [/\.exe$/],
      darwin: [/OSX.*\.zip$/, /darwin.*\.zip$/, /macOS.*\.zip$/, /mac.*\.zip$/, /\.dmg$/],
      linux: [/\.rpm$/, /\.deb$/]
    };
    possibleAssets = assets.filter(asset => {
      const targetSuffixes = installTargets[process.platform];

      for (const suffix of targetSuffixes) {
        if (suffix.test(asset.name)) return true;
      }

      return false;
    });

    if (possibleAssets.length === 0) {
      throw new Error(`Failed to find any installable assets for target platform: ${`${process.platform}`.cyan}`);
    }
  });
  (0, _messages.info)(interactive, `Found latest release${prerelease ? ' (including prereleases)' : ''}: ${latestRelease.tag_name.cyan}`);
  let targetAsset = possibleAssets[0];

  if (possibleAssets.length > 1) {
    targetAsset = await Promise.resolve(chooseAsset(possibleAssets));
  }

  const tmpdir = _path.default.resolve(_os.default.tmpdir(), 'forge-install');

  const pathSafeRepo = repo.replace(/[/\\]/g, '-');
  const filename = `${pathSafeRepo}-${latestRelease.tag_name}-${targetAsset.name}`;

  const fullFilePath = _path.default.resolve(tmpdir, filename);

  if (!(await _fsExtra.default.pathExists(fullFilePath)) || (await _fsExtra.default.stat(fullFilePath)).size !== targetAsset.size) {
    await _fsExtra.default.mkdirs(tmpdir);
    const nuggetOpts = {
      target: filename,
      dir: tmpdir,
      resume: true,
      strictSSL: true
    };
    await (0, _util.promisify)(nugget)(targetAsset.browser_download_url, nuggetOpts);
  }

  await (0, _asyncOra.asyncOra)('Installing Application', async installSpinner => {
    const installActions = {
      win32: {
        '.exe': _installerExe.default
      },
      darwin: {
        '.zip': _installerZip.default,
        '.dmg': _installerDmg.default
      },
      linux: {
        '.deb': _installerDeb.default,
        '.rpm': _installerRpm.default
      }
    };
    const suffixFnIdent = Object.keys(installActions[process.platform]).find(suffix => targetAsset.name.endsWith(suffix));

    if (!suffixFnIdent) {
      throw new Error(`No installer to handle "${targetAsset.name}"`);
    }

    const InstallerClass = installActions[process.platform][suffixFnIdent];
    const installer = new InstallerClass();
    await installer.install({
      installSpinner,
      filePath: fullFilePath
    });
  });
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvaW5zdGFsbC50cyJdLCJuYW1lcyI6WyJudWdnZXQiLCJyZXF1aXJlIiwiZCIsIkdJVEhVQl9BUEkiLCJJbnN0YWxsZXJJbXBsIiwiSW5zdGFsbGVyQmFzZSIsImludGVyYWN0aXZlIiwicHJlcmVsZWFzZSIsInJlcG8iLCJjaG9vc2VBc3NldCIsImFzeW5jT3JhIiwiRXJyb3IiLCJsYXRlc3RSZWxlYXNlIiwicG9zc2libGVBc3NldHMiLCJzZWFyY2hTcGlubmVyIiwiaW5kZXhPZiIsInJlbGVhc2VzIiwianNvbiIsImVyciIsIm1lc3NhZ2UiLCJBcnJheSIsImlzQXJyYXkiLCJsZW5ndGgiLCJmaWx0ZXIiLCJyZWxlYXNlIiwic29ydGVkUmVsZWFzZXMiLCJzb3J0IiwicmVsZWFzZUEiLCJyZWxlYXNlQiIsInRhZ0EiLCJ0YWdfbmFtZSIsInN1YnN0ciIsInRhZ0IiLCJzZW12ZXIiLCJndCIsInRleHQiLCJhc3NldHMiLCJpbnN0YWxsVGFyZ2V0cyIsIndpbjMyIiwiZGFyd2luIiwibGludXgiLCJhc3NldCIsInRhcmdldFN1ZmZpeGVzIiwicHJvY2VzcyIsInBsYXRmb3JtIiwic3VmZml4IiwidGVzdCIsIm5hbWUiLCJjeWFuIiwidGFyZ2V0QXNzZXQiLCJQcm9taXNlIiwicmVzb2x2ZSIsInRtcGRpciIsInBhdGgiLCJvcyIsInBhdGhTYWZlUmVwbyIsInJlcGxhY2UiLCJmaWxlbmFtZSIsImZ1bGxGaWxlUGF0aCIsImZzIiwicGF0aEV4aXN0cyIsInN0YXQiLCJzaXplIiwibWtkaXJzIiwibnVnZ2V0T3B0cyIsInRhcmdldCIsImRpciIsInJlc3VtZSIsInN0cmljdFNTTCIsImJyb3dzZXJfZG93bmxvYWRfdXJsIiwiaW5zdGFsbFNwaW5uZXIiLCJpbnN0YWxsQWN0aW9ucyIsIkV4ZUluc3RhbGxlciIsIlppcEluc3RhbGxlciIsIkRNR0luc3RhbGxlciIsIkRlYkluc3RhbGxlciIsIlJQTUluc3RhbGxlciIsInN1ZmZpeEZuSWRlbnQiLCJPYmplY3QiLCJrZXlzIiwiZmluZCIsImVuZHNXaXRoIiwiSW5zdGFsbGVyQ2xhc3MiLCJpbnN0YWxsZXIiLCJpbnN0YWxsIiwiZmlsZVBhdGgiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOzs7Ozs7QUFFQSxNQUFNQSxNQUFNLEdBQUdDLE9BQU8sQ0FBQyxRQUFELENBQXRCOztBQUVBLE1BQU1DLENBQUMsR0FBRyxvQkFBTSx3QkFBTixDQUFWO0FBRUEsTUFBTUMsVUFBVSxHQUFHLHdCQUFuQjs7QUFFQSxNQUFNQyxhQUFOLFNBQTRCQyxzQkFBNUIsQ0FBMEM7QUFBQTtBQUFBOztBQUFBLGtDQUFTLE1BQVQ7QUFBQTs7QUFBQTs7ZUFxQzNCLE9BQU87QUFDcEJDLEVBQUFBLFdBQVcsR0FBRyxLQURNO0FBRXBCQyxFQUFBQSxVQUFVLEdBQUcsS0FGTztBQUdwQkMsRUFBQUEsSUFIb0I7QUFJcEJDLEVBQUFBO0FBSm9CLENBQVAsS0FLTztBQUNwQkMscUJBQVNKLFdBQVQsR0FBdUJBLFdBQXZCOztBQUVBLE1BQUksT0FBT0csV0FBUCxLQUF1QixVQUEzQixFQUF1QztBQUNyQyxVQUFNLElBQUlFLEtBQUosQ0FBVSx1REFBVixDQUFOO0FBQ0Q7O0FBRUQsTUFBSUMsYUFBSjtBQUNBLE1BQUlDLGNBQXVCLEdBQUcsRUFBOUI7QUFFQSxRQUFNLHdCQUFTLDJCQUFULEVBQXNDLE1BQU9DLGFBQVAsSUFBeUI7QUFDbkUsUUFBSSxDQUFDTixJQUFELElBQVNBLElBQUksQ0FBQ08sT0FBTCxDQUFhLEdBQWIsTUFBc0IsQ0FBQyxDQUFwQyxFQUF1QztBQUNyQyxZQUFNLElBQUlKLEtBQUosQ0FBVSwyREFBVixDQUFOO0FBQ0Q7O0FBRURULElBQUFBLENBQUMsQ0FBQyxxQkFBRCxFQUF3Qk0sSUFBeEIsQ0FBRDtBQUNBLFFBQUlRLFFB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c0NvbnRlbnQiOlsiaW1wb3J0ICdjb2xvcnMnO1xuaW1wb3J0IHsgYXN5bmNPcmEgfSBmcm9tICdAZWxlY3Ryb24tZm9yZ2UvYXN5bmMtb3JhJztcbmltcG9ydCBJbnN0YWxsZXJCYXNlIGZyb20gJ0BlbGVjdHJvbi1mb3JnZS9pbnN0YWxsZXItYmFzZSc7XG5pbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnO1xuaW1wb3J0IGZldGNoIGZyb20gJ25vZGUtZmV0Y2gnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCBvcyBmcm9tICdvcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IHByb21pc2lmeSB9IGZyb20gJ3V0aWwnO1xuaW1wb3J0IHNlbXZlciBmcm9tICdzZW12ZXInO1xuXG5pbXBvcnQgRE1HSW5zdGFsbGVyIGZyb20gJ0BlbGVjdHJvbi1mb3JnZS9pbnN0YWxsZXItZG1nJztcbmltcG9ydCBaaXBJbnN0YWxsZXIgZnJvbSAnQGVsZWN0cm9uLWZvcmdlL2luc3RhbGxlci16aXAnO1xuaW1wb3J0IERlYkluc3RhbGxlciBmcm9tICdAZWxlY3Ryb24tZm9yZ2UvaW5zdGFsbGVyLWRlYic7XG5pbXBvcnQgUlBNSW5zdGFsbGVyIGZyb20gJ0BlbGVjdHJvbi1mb3JnZS9pbnN0YWxsZXItcnBtJztcbmltcG9ydCBFeGVJbnN0YWxsZXIgZnJvbSAnQGVsZWN0cm9uLWZvcmdlL2luc3RhbGxlci1leGUnO1xuXG5pbXBvcnQgeyBpbmZvIH0gZnJvbSAnLi4vdXRpbC9tZXNzYWdlcyc7XG5cbmNvbnN0IG51Z2dldCA9IHJlcXVpcmUoJ251Z2dldCcpO1xuXG5jb25zdCBkID0gZGVidWcoJ2VsZWN0cm9uLWZvcmdlOmluc3RhbGwnKTtcblxuY29uc3QgR0lUSFVCX0FQSSA9ICdodHRwczovL2FwaS5naXRodWIuY29tJztcblxuY2xhc3MgSW5zdGFsbGVySW1wbCBleHRlbmRzIEluc3RhbGxlckJhc2UgeyBuYW1lID0gJ2ltcGwnOyB9XG5cbmludGVyZmFjZSBSZWxlYXNlIHtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNhbWVsY2FzZVxuICB0YWdfbmFtZTogc3RyaW5nO1xuICBwcmVyZWxlYXNlOiBib29sZWFuO1xuICBhc3NldHM6IEFzc2V0W107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXNzZXQge1xuICBpZDogc3RyaW5nO1xuICBuYW1lOiBzdHJpbmc7XG4gIHNpemU6IG51bWJlcjtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNhbWVsY2FzZVxuICBicm93c2VyX2Rvd25sb2FkX3VybDogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEluc3RhbGxPcHRpb25zIHtcbiAgLyoqXG4gICAqIFdoZXRoZXIgdG8gdXNlIHNlbnNpYmxlIGRlZmF1bHRzIG9yIHByb21wdCB0aGUgdXNlciB2aXN1YWxseVxuICAgKi9cbiAgaW50ZXJhY3RpdmU/OiBib29sZWFuO1xuICAvKipcbiAgICogV2hldGhlciB0byBpbnN0YWxsIHByZXJlbGVhc2UgdmVyc2lvbnNcbiAgICovXG4gIHByZXJlbGVhc2U/OiBib29sZWFuO1xuICAvKipcbiAgICogVGhlIEdpdEh1YiByZXBvc2l0b3J5IHRvIGluc3RhbGwgZnJvbSwgaW4gdGhlIGZvcm1hdCBvd25lci9uYW1lXG4gICAqL1xuICByZXBvOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBBIGZ1bmN0aW9uIHRoYXQgbXVzdCByZXR1cm4gdGhlIGFzc2V0IHRvIHVzZS9pbnN0YWxsIGZyb20gYSBwcm92aWRlZCBhcnJheSBvZiBjb21wYXRpYmxlXG4gICAqIEdpdEh1YiBhc3NldHMuXG4gICAqL1xuICBjaG9vc2VBc3NldDogKGFzc2V0czogQXNzZXRbXSkgPT4gUHJvbWlzZTxBc3NldD4gfCBBc3NldDtcbn1cblxuZXhwb3J0IGRlZmF1bHQgYXN5bmMgKHtcbiAgaW50ZXJhY3RpdmUgPSBmYWxzZSxcbiAgcHJlcmVsZWFzZSA9IGZhbHNlLFxuICByZXBvLFxuICBjaG9vc2VBc3NldCxcbn06IEluc3RhbGxPcHRpb25zKSA9PiB7XG4gIGFzeW5jT3JhLmludGVyYWN0aXZlID0gaW50ZXJhY3RpdmU7XG5cbiAgaWYgKHR5cGVvZiBjaG9vc2VBc3NldCAhPT0gJ2Z1bmN0aW9uJykge1xuICAgIHRocm93IG5ldyBFcnJvcignRXhwZWN0ZWQgY2hvb3NlQXNzZXQgdG8gYmUgYSBmdW5jdGlvbiBpbiBpbnN0YWxsIGNhbGwnKTtcbiAgfVxuXG4gIGxldCBsYXRlc3RSZWxlYXNlITogUmVsZWFzZTtcbiAgbGV0IHBvc3NpYmxlQXNzZXRzOiBBc3NldFtdID0gW107XG5cbiAgYXdhaXQgYXN5bmNPcmEoJ1NlYXJjaGluZyBmb3IgQXBwbGljYXRpb24nLCBhc3luYyAoc2VhcmNoU3Bpbm5lcikgPT4ge1xuICAgIGlmICghcmVwbyB8fCByZXBvLmluZGV4T2YoJy8nKSA9PT0gLTEpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCByZXBvc2l0b3J5IG5hbWUsIG11c3QgYmUgaW4gdGhlIGZvcm1hdCBvd25lci9uYW1lJyk7XG4gICAgfVxuXG4gICAgZCgnc2VhcmNoaW5nIGZvciByZXBvOicsIHJlcG8pO1xuICAgIGxldCByZWxlYXNlcyE6IFJlbGVhc2VbXTtcbiAgICB0cnkge1xuICAgICAgcmVsZWFzZXMgPSBhd2FpdCAoYXdhaXQgZmV0Y2goYCR7R0lUSFVCX0FQSX0vcmVwb3MvJHtyZXBvfS9yZWxlYXNlc2ApKS5qc29uKCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAvLyBJZ25vcmUgZXJyb3JcbiAgICB9XG5cbiAgICBpZiAoIXJlbGVhc2VzIHx8IChyZWxlYXNlcyBhcyBhbnkpLm1lc3NhZ2UgPT09ICdOb3QgRm91bmQnIHx8ICFBcnJheS5pc0FycmF5KHJlbGVhc2VzKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gZmluZCByZWxlYXNlcyBmb3IgcmVwb3NpdG9yeSBcIiR7cmVwb31cIi4gIFBsZWFzZSBjaGVjayB0aGUgbmFtZSBhbmQgdHJ5IGFnYWluLmApO1xuICAgIH1cblxuICAgIGlmIChyZWxlYXNlcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgUmVwb3NpdG9yeSBcIiR7cmVwb31cIiBoYXMgbm8gcmVsZWFzZXNgKTtcbiAgICB9XG5cbiAgICByZWxlYXNlcyA9IHJlbGVhc2VzLmZpbHRlcigocmVsZWFzZSkgPT4gIXJlbGVhc2UucHJlcmVsZWFzZSB8fCBwcmVyZWxlYXNlKTtcblxuICAgIGNvbnN0IHNvcnRlZFJlbGVhc2VzID0gcmVsZWFzZXMuc29ydCgocmVsZWFzZUEsIHJlbGVhc2VCKSA9PiB7XG4gICAgICBsZXQgdGFnQSA9IHJlbGVhc2VBLnRhZ19uYW1lO1xuICAgICAgaWYgKHRhZ0Euc3Vic3RyKDAsIDEpID09PSAndicpIHRhZ0EgPSB0YWdBLnN1YnN0cigxKTtcbiAgICAgIGxldCB0YWdCID0gcmVsZWFzZUIudGFnX25hbWU7XG4gICAgICBpZiAodGFnQi5zdWJzdHIoMCwgMSkgPT09ICd2JykgdGFnQiA9IHRhZ0Iuc3Vic3RyKDEpO1xuICAgICAgcmV0dXJuIChzZW12ZXIuZ3QodGFnQiwgdGFnQSkgPyAxIDogLTEpO1xuICAgIH0pO1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBwcmVmZXItZGVzdHJ1Y3R1cmluZ1xuICAgIGxhdGVzdFJlbGVhc2UgPSBzb3J0ZWRSZWxlYXNlc1swXTtcblxuICAgIHNlYXJjaFNwaW5uZXIudGV4dCA9ICdTZWFyY2hpbmcgZm9yIFJlbGVhc2VzJztcblxuICAgIGNvbnN0IHsgYXNzZXRzIH0gPSBsYXRlc3RSZWxlYXNlO1xuICAgIGlmICghYXNzZXRzIHx8ICFBcnJheS5pc0FycmF5KGFzc2V0cykgfHwgYXNzZXRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb3VsZCBub3QgZmluZCBhbnkgYXNzZXRzIGZvciB0aGUgbGF0ZXN0IHJlbGVhc2UnKTtcbiAgICB9XG5cbiAgICBjb25zdCBpbnN0YWxsVGFyZ2V0czoge1xuICAgICAgW2tleTogc3RyaW5nXTogUmVnRXhwW107XG4gICAgfSA9IHtcbiAgICAgIHdpbjMyOiBbL1xcLmV4ZSQvXSxcbiAgICAgIGRhcndpbjogWy9PU1guKlxcLnppcCQvLCAvZGFyd2luLipcXC56aXAkLywgL21hY09TLipcXC56aXAkLywgL21hYy4qXFwuemlwJC8sIC9cXC5kbWckL10sXG4gICAgICBsaW51eDogWy9cXC5ycG0kLywgL1xcLmRlYiQvXSxcbiAgICB9O1xuXG4gICAgcG9zc2libGVBc3NldHMgPSBhc3NldHMuZmlsdGVyKChhc3NldCkgPT4ge1xuICAgICAgY29uc3QgdGFyZ2V0U3VmZml4ZXMgPSBpbnN0YWxsVGFyZ2V0c1twcm9jZXNzLnBsYXRmb3JtXTtcbiAgICAgIGZvciAoY29uc3Qgc3VmZml4IG9mIHRhcmdldFN1ZmZpeGVzKSB7XG4gICAgICAgIGlmIChzdWZmaXgudGVzdChhc3NldC5uYW1lKSkgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfSk7XG5cbiAgICBpZiAocG9zc2libGVBc3NldHMubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBmaW5kIGFueSBpbnN0YWxsYWJsZSBhc3NldHMgZm9yIHRhcmdldCBwbGF0Zm9ybTogJHtgJHtwcm9jZXNzLnBsYXRmb3JtfWAuY3lhbn1gKTtcbiAgICB9XG4gIH0pO1xuXG4gIGluZm8oaW50ZXJhY3RpdmUsIGBGb3VuZCBsYXRlc3QgcmVsZWFzZSR7cHJlcmVsZWFzZSA/ICcgKGluY2x1ZGluZyBwcmVyZWxlYXNlcyknIDogJyd9OiAke2xhdGVzdFJlbGVhc2UudGFnX25hbWUuY3lhbn1gKTtcblxuICBsZXQgdGFyZ2V0QXNzZXQgPSBwb3NzaWJsZUFzc2V0c1swXTtcbiAgaWYgKHBvc3NpYmxlQXNzZXRzLmxlbmd0aCA+IDEpIHtcbiAgICB0YXJnZXRBc3NldCA9IGF3YWl0IFByb21pc2UucmVzb2x2ZShjaG9vc2VBc3NldChwb3NzaWJsZUFzc2V0cykpO1xuICB9XG5cbiAgY29uc3QgdG1wZGlyID0gcGF0aC5yZXNvbHZlKG9zLnRtcGRpcigpLCAnZm9yZ2UtaW5zdGFsbCcpO1xuICBjb25zdCBwYXRoU2FmZVJlcG8gPSByZXBvLnJlcGxhY2UoL1svXFxcXF0vZywgJy0nKTtcbiAgY29uc3QgZmlsZW5hbWUgPSBgJHtwYXRoU2FmZVJlcG99LSR7bGF0ZXN0UmVsZWFzZS50YWdfbmFtZX0tJHt0YXJnZXRBc3NldC5uYW1lfWA7XG5cbiAgY29uc3QgZnVsbEZpbGVQYXRoID0gcGF0aC5yZXNvbHZlKHRtcGRpciwgZmlsZW5hbWUpO1xuICBpZiAoIWF3YWl0IGZzLnBhdGhFeGlzdHMoZnVsbEZpbGVQYXRoKVxuICAgICAgfHwgKGF3YWl0IGZzLnN0YXQoZnVsbEZpbGVQYXRoKSkuc2l6ZSAhPT0gdGFyZ2V0QXNzZXQuc2l6ZSkge1xuICAgIGF3YWl0IGZzLm1rZGlycyh0bXBkaXIpO1xuXG4gICAgY29uc3QgbnVnZ2V0T3B0cyA9IHtcbiAgICAgIHRhcmdldDogZmlsZW5hbWUsXG4gICAgICBkaXI6IHRtcGRpcixcbiAgICAgIHJlc3VtZTogdHJ1ZSxcbiAgICAgIHN0cmljdFNTTDogdHJ1ZSxcbiAgICB9O1xuICAgIGF3YWl0IHByb21pc2lmeShudWdnZXQpKHRhcmdldEFzc2V0LmJyb3dzZXJfZG93bmxvYWRfdXJsLCBudWdnZXRPcHRzKTtcbiAgfVxuXG4gIGF3YWl0IGFzeW5jT3JhKCdJbnN0YWxsaW5nIEFwcGxpY2F0aW9uJywgYXN5bmMgKGluc3RhbGxTcGlubmVyKSA9PiB7XG4gICAgY29uc3QgaW5zdGFsbEFjdGlvbnM6IHtcbiAgICAgIFtrZXk6IHN0cmluZ106IHtcbiAgICAgICAgW2tleTogc3RyaW5nXTogdHlwZW9mIEluc3RhbGxlckltcGw7XG4gICAgICB9O1xuICAgIH0gPSB7XG4gICAgICB3aW4zMjoge1xuICAgICAgICAnLmV4ZSc6IEV4ZUluc3RhbGxlcixcbiAgICAgIH0sXG4gICAgICBkYXJ3aW46IHtcbiAgICAgICAgJy56aXAnOiBaaXBJbnN0YWxsZXIsXG4gICAgICAgICcuZG1nJzogRE1HSW5zdGFsbGVyLFxuICAgICAgfSxcbiAgICAgIGxpbnV4OiB7XG4gICAgICAgICcuZGViJzogRGViSW5zdGFsbGVyLFxuICAgICAgICAnLnJwbSc6IFJQTUluc3RhbGxlcixcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIGNvbnN0IHN1ZmZpeEZuSWRlbnQgPSBPYmplY3Qua2V5cyhpbnN0YWxsQWN0aW9uc1twcm9jZXNzLnBsYXRmb3JtXSlcbiAgICAgIC5maW5kKChzdWZmaXgpID0+IHRhcmdldEFzc2V0Lm5hbWUuZW5kc1dpdGgoc3VmZml4KSk7XG4gICAgaWYgKCFzdWZmaXhGbklkZW50KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIGluc3RhbGxlciB0byBoYW5kbGUgXCIke3RhcmdldEFzc2V0Lm5hbWV9XCJgKTtcbiAgICB9XG4gICAgY29uc3QgSW5zdGFsbGVyQ2xhc3MgPSBpbnN0YWxsQWN0aW9uc1twcm9jZXNzLnBsYXRmb3JtXVtzdWZmaXhGbklkZW50XTtcbiAgICBjb25zdCBpbnN0YWxsZXIgPSBuZXcgSW5zdGFsbGVyQ2xhc3MoKTtcbiAgICBhd2FpdCBpbnN0YWxsZXIuaW5zdGFsbCh7IGluc3RhbGxTcGlubmVyLCBmaWxlUGF0aDogZnVsbEZpbGVQYXRoIH0pO1xuICB9KTtcbn07XG4iXX0=