"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

require("colors");

var _asyncOra = require("@electron-forge/async-ora");

var _debug = _interopRequireDefault(require("debug"));

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _get = require("@electron/get");

var _glob = _interopRequireDefault(require("glob"));

var _electronPackager = _interopRequireDefault(require("electron-packager"));

var _path = _interopRequireDefault(require("path"));

var _util = require("util");

var _forgeConfig = _interopRequireDefault(require("../util/forge-config"));

var _hook = require("../util/hook");

var _messages = require("../util/messages");

var _readPackageJson = require("../util/read-package-json");

var _rebuild = _interopRequireDefault(require("../util/rebuild"));

var _requireSearch = _interopRequireDefault(require("../util/require-search"));

var _resolveDir = _interopRequireDefault(require("../util/resolve-dir"));

var _outDir = _interopRequireDefault(require("../util/out-dir"));

var _electronVersion = require("../util/electron-version");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const d = (0, _debug.default)('electron-forge:packager');

/**
 * Resolves hooks if they are a path to a file (instead of a `Function`).
 */
function resolveHooks(hooks, dir) {
  if (hooks) {
    return hooks.map(hook => typeof hook === 'string' ? (0, _requireSearch.default)(dir, [hook]) : hook);
  }

  return [];
}
/**
 * Runs given hooks sequentially by mapping them to promises and iterating
 * through while awaiting
 */


function sequentialHooks(hooks) {
  return [async (...args) => {
    const done = args[args.length - 1];
    const passedArgs = args.splice(0, args.length - 1);

    for (const hook of hooks) {
      await (0, _util.promisify)(hook)(...passedArgs);
    }

    done();
  }];
}

var _default = async ({
  dir = process.cwd(),
  interactive = false,
  arch = (0, _get.getHostArch)(),
  platform = process.platform,
  outDir
}) => {
  const ora = interactive ? _asyncOra.ora : _asyncOra.fakeOra;
  let prepareSpinner = ora(`Preparing to Package Application for arch: ${(arch === 'all' ? 'ia32' : arch).cyan}`).start();
  let prepareCounter = 0;
  const resolvedDir = await (0, _resolveDir.default)(dir);

  if (!resolvedDir) {
    throw new Error('Failed to locate compilable Electron application');
  }

  dir = resolvedDir;
  const forgeConfig = await (0, _forgeConfig.default)(dir);
  const packageJSON = await (0, _readPackageJson.readMutatedPackageJson)(dir, forgeConfig);

  if (!packageJSON.main) {
    throw new Error('packageJSON.main must be set to a valid entry point for your Electron app');
  }

  const calculatedOutDir = outDir || (0, _outDir.default)(dir, forgeConfig);
  let packagerSpinner = null;
  const pruneEnabled = !('prune' in forgeConfig.packagerConfig) || forgeConfig.packagerConfig.prune;
  const afterCopyHooks = [async (buildPath, electronVersion, pPlatform, pArch, done) => {
    if (packagerSpinner) {
      packagerSpinner.succeed();
      prepareCounter += 1;
      prepareSpinner = ora(`Preparing to Package Application for arch: ${(prepareCounter === 2 ? 'armv7l' : 'x64').cyan}`).start();
    }

    const bins = await (0, _util.promisify)(_glob.default)(_path.default.join(buildPath, '**/.bin/**/*'));

    for (const bin of bins) {
      await _fsExtra.default.remove(bin);
    }

    done();
  }, async (buildPath, electronVersion, pPlatform, pArch, done) => {
    prepareSpinner.succeed();
    await (0, _hook.runHook)(forgeConfig, 'packageAfterCopy', buildPath, electronVersion, pPlatform, pArch);
    done();
  }, async (buildPath, electronVersion, pPlatform, pArch, done) => {
    await (0, _rebuild.default)(buildPath, electronVersion, pPlatform, pArch, forgeConfig.electronRebuildConfig);
    packagerSpinner = ora('Packaging Application').start();
    done();
  }];
  afterCopyHooks.push(async (buildPath, electronVersion, pPlatform, pArch, done) => {
    const copiedPackageJSON = await (0, _readPackageJson.readMutatedPackageJson)(buildPath, forgeConfig);

    if (copiedPackageJSON.config && copiedPackageJSON.config.forge) {
      delete copiedPackageJSON.config.forge;
    }

    await _fsExtra.default.writeJson(_path.default.resolve(buildPath, 'package.json'), copiedPackageJSON, {
      spaces: 2
    });
    done();
  });
  afterCopyHooks.push(...resolveHooks(forgeConfig.packagerConfig.afterCopy, dir));
  const afterPruneHooks = [];

  if (pruneEnabled) {
    afterPruneHooks.push(...resolveHooks(forgeConfig.packagerConfig.afterPrune, dir));
  }

  afterPruneHooks.push(async (buildPath, electronVersion, pPlatform, pArch, done) => {
    await (0, _hook.runHook)(forgeConfig, 'packageAfterPrune', buildPath, electronVersion, pPlatform, pArch);
    done();
  });
  const afterExtractHooks = [async (buildPath, electronVersion, pPlatform, pArch, done) => {
    await (0, _hook.runHook)(forgeConfig, 'packageAfterExtract', buildPath, electronVersion, pPlatform, pArch);
    done();
  }];
  afterExtractHooks.push(...resolveHooks(forgeConfig.packagerConfig.afterExtract, dir));

  const packageOpts = _objectSpread({
    asar: false,
    overwrite: true
  }, forgeConfig.packagerConfig, {
    dir,
    arch: arch,
    platform,
    afterCopy: sequentialHooks(afterCopyHooks),
    afterExtract: sequentialHooks(afterExtractHooks),
    afterPrune: sequentialHooks(afterPruneHooks),
    out: calculatedOutDir,
    electronVersion: await (0, _electronVersion.getElectronVersion)(dir, packageJSON)
  });

  packageOpts.quiet = true;

  if (packageOpts.all) {
    throw new Error('config.forge.packagerConfig.all is not supported by Electron Forge');
  }

  if (!packageJSON.version && !packageOpts.appVersion) {
    // eslint-disable-next-line max-len
    (0, _messages.warn)(interactive, 'Please set "version" or "config.forge.packagerConfig.appVersion" in your application\'s package.json so auto-updates work properly'.yellow);
  }

  if (packageOpts.prebuiltAsar) {
    throw new Error('config.forge.packagerConfig.prebuiltAsar is not supported by Electron Forge');
  }

  await (0, _hook.runHook)(forgeConfig, 'generateAssets');
  await (0, _hook.runHook)(forgeConfig, 'prePackage');
  d('packaging with options', packageOpts);
  await (0, _electronPackager.default)(packageOpts);
  await (0, _hook.runHook)(forgeConfig, 'postPackage');
  if (packagerSpinner) packagerSpinner.succeed();
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvcGFja2FnZS50cyJdLCJuYW1lcyI6WyJkIiwicmVzb2x2ZUhvb2tzIiwiaG9va3MiLCJkaXIiLCJtYXAiLCJob29rIiwic2VxdWVudGlhbEhvb2tzIiwiYXJncyIsImRvbmUiLCJsZW5ndGgiLCJwYXNzZWRBcmdzIiwic3BsaWNlIiwicHJvY2VzcyIsImN3ZCIsImludGVyYWN0aXZlIiwiYXJjaCIsInBsYXRmb3JtIiwib3V0RGlyIiwib3JhIiwicmVhbE9yYSIsImZha2VPcmEiLCJwcmVwYXJlU3Bpbm5lciIsImN5YW4iLCJzdGFydCIsInByZXBhcmVDb3VudGVyIiwicmVzb2x2ZWREaXIiLCJFcnJvciIsImZvcmdlQ29uZmlnIiwicGFja2FnZUpTT04iLCJtYWluIiwiY2FsY3VsYXRlZE91dERpciIsInBhY2thZ2VyU3Bpbm5lciIsInBydW5lRW5hYmxlZCIsInBhY2thZ2VyQ29uZmlnIiwicHJ1bmUiLCJhZnRlckNvcHlIb29rcyIsImJ1aWxkUGF0aCIsImVsZWN0cm9uVmVyc2lvbiIsInBQbGF0Zm9ybSIsInBBcmNoIiwic3VjY2VlZCIsImJpbnMiLCJnbG9iIiwicGF0aCIsImpvaW4iLCJiaW4iLCJmcyIsInJlbW92ZSIsImVsZWN0cm9uUmVidWlsZENvbmZpZyIsInB1c2giLCJjb3BpZWRQYWNrYWdlSlNPTiIsImNvbmZpZyIsImZvcmdlIiwid3JpdGVKc29uIiwicmVzb2x2ZSIsInNwYWNlcyIsImFmdGVyQ29weSIsImFmdGVyUHJ1bmVIb29rcyIsImFmdGVyUHJ1bmUiLCJhZnRlckV4dHJhY3RIb29rcyIsImFmdGVyRXh0cmFjdCIsInBhY2thZ2VPcHRzIiwiYXNhciIsIm92ZXJ3cml0ZSIsIm91dCIsInF1aWV0IiwiYWxsIiwidmVyc2lvbiIsImFwcFZlcnNpb24iLCJ5ZWxsb3ciLCJwcmVidWlsdEFzYXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7Ozs7O0FBRUEsTUFBTUEsQ0FBQyxHQUFHLG9CQUFNLHlCQUFOLENBQVY7O0FBVUE7OztBQUdBLFNBQVNDLFlBQVQsQ0FBc0JDLEtBQXRCLEVBQXFGQyxHQUFyRixFQUFrRztBQUNoRyxNQUFJRCxLQUFKLEVBQVc7QUFDVCxXQUFPQSxLQUFLLENBQUNFLEdBQU4sQ0FBV0MsSUFBRCxJQUNmLE9BQU9BLElBQVAsS0FBZ0IsUUFBaEIsR0FDSSw0QkFBNkNGLEdBQTdDLEVBQWtELENBQUNFLElBQUQsQ0FBbEQsQ0FESixHQUVJQSxJQUhDLENBQVA7QUFLRDs7QUFFRCxTQUFPLEVBQVA7QUFDRDtBQUVEOzs7Ozs7QUFJQSxTQUFTQyxlQUFULENBQXlCSixLQUF6QixFQUE0QztBQUMxQyxTQUFPLENBQUMsT0FBTyxHQUFHSyxJQUFWLEtBQTBCO0FBQ2hDLFVBQU1DLElBQUksR0FBR0QsSUFBSSxDQUFDQSxJQUFJLENBQUNFLE1BQUwsR0FBYyxDQUFmLENBQWpCO0FBQ0EsVUFBTUMsVUFBVSxHQUFHSCxJQUFJLENBQUNJLE1BQUwsQ0FBWSxDQUFaLEVBQWVKLElBQUksQ0FBQ0UsTUFBTCxHQUFjLENBQTdCLENBQW5COztBQUNBLFNBQUssTUFBTUosSUFBWCxJQUFtQkgsS0FBbkIsRUFBMEI7QUFDeEIsWUFBTSxxQkFBVUcsSUFBVixFQUFnQixHQUFHSyxVQUFuQixDQUFOO0FBQ0Q7O0FBQ0RGLElBQUFBLElBQUk7QUFDTCxHQVBNLENBQVA7QUFRRDs7ZUF5QmMsT0FBTztBQUNwQkwsRUFBQUEsR0FBRyxHQUFHUyxPQUFPLENBQUNDLEdBQVIsRUFEYztBQUVwQkMsRUFBQUEsV0FBVyxHQUFHLEtBRk07QUFHcEJDLEVBQUFBLElBQUksR0FBRyx1QkFIYTtBQUlwQkMsRUFBQUEsUUFBUSxHQUFHSixPQUFPLENBQUNJLFFBSkM7QUFLcEJDLEVBQUFBO0FBTG9CLENBQVAsS0FNTztBQUNwQixRQUFNQyxHQUFHLEdBQUdKLFdBQVcsR0FBR0ssYUFBSCxHQUFhQyxpQkFBcEM7QUFFQSxNQUFJQyxjQUFjLEdBQUdILEdBQUcsQ0FBRSw4Q0FBNkMsQ0FBQ0gsSUFBSSxLQUFLLEtBQVQsR0FBaUIsTUFBakIsR0FBMEJBLElBQTNCLEVBQWlDTyxJQUFLLEVBQXJGLENBQUgsQ0FBMkZDLEtBQTNGLEVBQXJCO0FBQ0EsTUFBSUMsY0FBYyxHQUFHLENBQXJCO0FBRUEsUUFBTUMsV0FBVyxHQUFHLE1BQU0seUJBQVd0QixHQUFYLENBQTFCOztBQUNBLE1BQUksQ0FBQ3NCLFdBQUwsRUFBa0I7QUFDaEIsVUFBTSxJQUFJQyxLQUFKLENBQVUsa0RBQVYsQ0FBTjtBQUNEOztBQUNEdkIsRUFBQUEsR0FBRyxHQUFHc0IsV0FBTjtBQUVBLFFBQU1FLFdBQVcsR0FBRyxNQUFNLDBCQUFleEIsR0FBZixDQUExQjtBQUNBLFFBQU15QixXQUFXLEdBQUcsTUFBTSw2Q0FBdUJ6QixHQUF2QixFQUE0QndCLFdBQTVCLENBQTFCOztBQUVBLE1BQUksQ0FBQ0MsV0FBVyxDQUFDQyxJQUFqQixFQUF1QjtBQUNyQixVQUFNLElBQUlILEtBQUosQ0FBVSwyRUFBVixDQUFOO0FBQ0Q7O0FBRUQsUUFBTUksZ0JBQWdCLEdBQUdiLE1BQU0sSUFBSSxxQkFBaUJkLEdBQWpCLEVBQXNCd0IsV0FBdEIsQ0FBbkM7QUFDQSxNQUFJSSxlQUErQixHQUFHLElBQXRDO0FBRUEsUUFBTUMsWUFBWSxHQUFHLEVBQUUsV0FBV0wsV0FBVyxDQUFDTSxjQUF6QixLQUE0Q04sV0FBVyxDQUFDTSxjQUFaLENBQTJCQyxLQUE1RjtBQUVBLFFBQU1DLGNBQStDLEdBQUcsQ0FDdEQsT0FBT0MsU0FBUCxFQUFrQkMsZUFBbEIsRUFBbUNDLFNBQW5DLEVBQThDQyxLQUE5QyxFQUFxRC9CLElBQXJELEtBQThEO0FBQzVELFFBQUl1QixlQUFKLEVBQXFCO0FBQ25CQSxNQUFBQSxlQUFlLENBQUNTLE9BQWhCO0FBQ0FoQixNQUFBQSxjQUFjLElBQUksQ0FBbEI7QUFDQUgsTUFBQUEsY0FBYyxHQUFHSCxHQUFHLENBQUUsOENBQTZDLENBQUNNLGNBQWMsS0FBSyxDQUFuQixHQUF1QixRQUF2QixHQUFrQyxLQUFuQyxFQUEwQ0YsSUFBSyxFQUE5RixDQUFILENBQW9HQyxLQUFwRyxFQUFqQjtBQUNEOztBQUNELFVBQU1rQixJQUFJLEdBQUcsTUFBTSxxQkFBVUMsYUFBVixFQUFnQkMsY0FBS0MsSUFBTCxDQUFVUixTQUFWLEVBQXFCLGNBQXJCLENBQWhCLENBQW5COztBQUNBLFNBQUssTUFBTVMsR0FBWCxJQUFrQkosSUFBbEIsRUFBd0I7QUFDdEIsWUFBTUssaUJBQUdDLE1BQUgsQ0FBVUYsR0FBVixDQUFOO0FBQ0Q7O0FBQ0RyQyxJQUFBQSxJQUFJO0FBQ0wsR0FacUQsRUFZbkQsT0FBTzRCLFNBQVAsRUFBa0JDLGVBQWxCLEVBQW1DQyxTQUFuQyxFQUE4Q0MsS0FBOUMsRUFBcUQvQixJQUFyRCxLQUE4RDtBQUMvRGEsSUFBQUEsY0FBYyxDQUFDbUIsT0FBZjtBQUNBLFVBQU0sbUJBQVFiLFdBQVIsRUFBcUIsa0JBQXJCLEVBQXlDUyxTQUF6QyxFQUFvREMsZUFBcEQsRUFBcUVDLFNBQXJFLEVBQWdGQyxLQUFoRixDQUFOO0FBQ0EvQixJQUFBQSxJQUFJO0FBQ0wsR0FoQnFELEVBaUJ0RCxPQUFPNEIsU0FBUCxFQUFrQkMsZUFBbEIsRUFBbUNDLFNBQW5DLEVBQThDQyxLQUE5QyxFQUFxRC9CLElBQXJELEtBQThEO0FBQzVELFVBQU0sc0JBQ0o0QixTQURJLEVBRUpDLGVBRkksRUFHSkMsU0FISSxFQUlKQyxLQUpJLEVBS0paLFdBQVcsQ0FBQ3FCLHFCQUxSLENBQU47QUFPQWpCLElBQUFBLGVBQWUsR0FBR2IsR0FBRyxDQUFDLHVCQUFELENBQUgsQ0FBNkJLLEtBQTdCLEVBQWxCO0FBQ0FmLElBQUFBLElBQUk7QUFDTCxHQTNCcUQsQ0FBeEQ7QUE4QkEyQixFQUFBQSxjQUFjLENBQUNjLElBQWYsQ0FBb0IsT0FBT2IsU0FBUCxFQUFrQkMsZUFBbEIsRUFBbUNDLFNBQW5DLEVBQThDQyxLQUE5QyxFQUFxRC9CLElBQXJELEtBQThEO0FBQ2hGLFVBQU0wQyxpQkFBaUIsR0FBRyxNQUFNLDZDQUF1QmQsU0FBdkIsRUFBa0NULFdBQWxDLENBQWhDOztBQUNBLFFBQUl1QixpQkFBaUIsQ0FBQ0MsTUFBbEIsSUFBNEJELGlCQUFpQixDQUFDQyxNQUFsQixDQUF5QkMsS0FBekQsRUFBZ0U7QUFDOUQsYUFBT0YsaUJBQWlCLENBQUNDLE1BQWxCLENBQXlCQyxLQUFoQztBQUNEOztBQUNELFVBQU1OLGlCQUFHTyxTQUFILENBQWFWLGNBQUtXLE9BQUwsQ0FBYWxCLFNBQWIsRUFBd0IsY0FBeEIsQ0FBYixFQUFzRGMsaUJBQXRELEVBQXlFO0FBQUVLLE1BQUFBLE1BQU0sRUFBRTtBQUFWLEtBQXpFLENBQU47QUFDQS9DLElBQUFBLElBQUk7QUFDTCxHQVBEO0FBU0EyQixFQUFBQSxjQUFjLENBQUNjLElBQWYsQ0FBb0IsR0FBR2hELFlBQVksQ0FBQzBCLFdBQVcsQ0FBQ00sY0FBWixDQUEyQnVCLFNBQTVCLEVBQXVDckQsR0FBdkMsQ0FBbkM7QUFFQSxRQUFNc0QsZUFBZSxHQUFHLEVBQXhCOztBQUVBLE1BQUl6QixZQUFKLEVBQWtCO0FBQ2hCeUIsSUFBQUEsZUFBZSxDQUFDUixJQUFoQixDQUFxQixHQUFHaEQsWUFBWSxDQUFDMEIsV0FBVyxDQUFDTSxjQUFaLENBQTJCeUIsVUFBNUIsRUFBd0N2RCxHQUF4QyxDQUFwQztBQUNEOztBQUVEc0QsRUFBQUEsZUFBZSxDQUFDUixJQUFoQixDQUFzQixPQUFPYixTQUFQLEVBQWtCQyxlQUFsQixFQUFtQ0MsU0FBbkMsRUFBOENDLEtBQTlDLEVBQXFEL0IsSUFBckQsS0FBOEQ7QUFDbEYsVUFBTSxtQkFBUW1CLFdBQVIsRUFBcUIsbUJBQXJCLEVBQTBDUyxTQUExQyxFQUFxREMsZUFBckQsRUFBc0VDLFNBQXRFLEVBQWlGQyxLQUFqRixDQUFOO0FBQ0EvQixJQUFBQSxJQUFJO0FBQ0wsR0FIRDtBQUtBLFFBQU1tRCxpQkFBaUIsR0FBRyxDQUFFLE9BQU92QixTQUFQLEVBQWtCQyxlQUFsQixFQUFtQ0MsU0FBbkMsRUFBOENDLEtBQTlDLEVBQXFEL0IsSUFBckQsS0FBOEQ7QUFDeEYsVUFBTSxtQkFBUW1CLFdBQVIsRUFBcUIscUJBQXJCLEVBQTRDUyxTQUE1QyxFQUF1REMsZUFBdkQsRUFBd0VDLFNBQXhFLEVBQW1GQyxLQUFuRixDQUFOO0FBQ0EvQixJQUFBQSxJQUFJO0FBQ0wsR0FIeUIsQ0FBMUI7QUFJQW1ELEVBQUFBLGlCQUFpQixDQUFDVixJQUFsQixDQUF1QixHQUFHaEQsWUFBWSxDQUFDMEIsV0FBVyxDQUFDTSxjQUFaLENBQTJCMkIsWUFBNUIsRUFBMEN6RCxHQUExQyxDQUF0Qzs7QUFJQSxRQUFNMEQsV0FBNkI7QUFDakNDLElBQUFBLElBQUksRUFBRSxLQUQyQjtBQUVqQ0MsSUFBQUEsU0FBUyxFQUFFO0FBRnNCLEtBRzlCcEMsV0FBVyxDQUFDTSxjQUhrQjtBQUlqQzlCLElBQUFBLEdBSmlDO0FBS2pDWSxJQUFBQSxJQUFJLEVBQUVBLElBTDJCO0FBTWpDQyxJQUFBQSxRQU5pQztBQU9qQ3dDLElBQUFBLFNBQVMsRUFBRWxELGVBQWUsQ0FBQzZCLGNBQUQsQ0FQTztBQVFqQ3lCLElBQUFBLFlBQVksRUFBRXRELGVBQWUsQ0FBQ3FELGlCQUFELENBUkk7QUFTakNELElBQUFBLFVBQVUsRUFBRXBELGVBQWUsQ0FBQ21ELGVBQUQsQ0FUTTtBQVVqQ08sSUFBQUEsR0FBRyxFQUFFbEMsZ0JBVjRCO0FBV2pDTyxJQUFBQSxlQUFlLEVBQUUsTUFBTSx5Q0FBbUJsQyxHQUFuQixFQUF3QnlCLFdBQXhCO0FBWFUsSUFBbkM7O0FBYUFpQyxFQUFBQSxXQUFXLENBQUNJLEtBQVosR0FBb0IsSUFBcEI7O0FBRUEsTUFBSUosV0FBVyxDQUFDSyxHQUFoQixFQUFxQjtBQUNuQixVQUFNLElBQUl4QyxLQUFKLENBQVUsb0VBQVYsQ0FBTjtBQUNEOztBQUVELE1BQUksQ0FBQ0UsV0FBVyxDQUFDdUMsT0FBYixJQUF3QixDQUFDTixXQUFXLENBQUNPLFVBQXpDLEVBQXFEO0FBQ25EO0FBQ0Esd0JBQUt0RCxXQUFMLEVBQWtCLHFJQUFxSXVELE1BQXZKO0FBQ0Q7O0FBRUQsTUFBSVIsV0FBVyxDQUFDUyxZQUFoQixFQUE4QjtBQUM1QixVQUFNLElBQUk1QyxLQUFKLENBQVUsNkVBQVYsQ0FBTjtBQUNEOztBQUVELFFBQU0sbUJBQVFDLFdBQVIsRUFBcUIsZ0JBQXJCLENBQU47QUFDQSxRQUFNLG1CQUFRQSxXQUFSLEVBQXFCLFlBQXJCLENBQU47QUFFQTNCLEVBQUFBLENBQUMsQ0FBQyx3QkFBRCxFQUEyQjZELFdBQTNCLENBQUQ7QUFFQSxRQUFNLCtCQUFTQSxXQUFULENBQU47QUFFQSxRQUFNLG1CQUFRbEMsV0FBUixFQUFxQixhQUFyQixDQUFOO0FBRUEsTUFBSUksZUFBSixFQUFxQkEsZUFBZSxDQUFFUyxPQUFqQjtBQUN0QixDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICdjb2xvcnMnO1xuaW1wb3J0IHsgb3JhIGFzIHJlYWxPcmEsIGZha2VPcmEsIE9yYUltcGwgfSBmcm9tICdAZWxlY3Ryb24tZm9yZ2UvYXN5bmMtb3JhJztcbmltcG9ydCB7IEZvcmdlQXJjaCwgRm9yZ2VQbGF0Zm9ybSB9IGZyb20gJ0BlbGVjdHJvbi1mb3JnZS9zaGFyZWQtdHlwZXMnO1xuaW1wb3J0IGRlYnVnIGZyb20gJ2RlYnVnJztcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgeyBnZXRIb3N0QXJjaCB9IGZyb20gJ0BlbGVjdHJvbi9nZXQnO1xuaW1wb3J0IGdsb2IgZnJvbSAnZ2xvYic7XG5pbXBvcnQgcGFja2FnZXIgZnJvbSAnZWxlY3Ryb24tcGFja2FnZXInO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBwcm9taXNpZnkgfSBmcm9tICd1dGlsJztcblxuaW1wb3J0IGdldEZvcmdlQ29uZmlnIGZyb20gJy4uL3V0aWwvZm9yZ2UtY29uZmlnJztcbmltcG9ydCB7IHJ1bkhvb2sgfSBmcm9tICcuLi91dGlsL2hvb2snO1xuaW1wb3J0IHsgd2FybiB9IGZyb20gJy4uL3V0aWwvbWVzc2FnZXMnO1xuaW1wb3J0IHsgcmVhZE11dGF0ZWRQYWNrYWdlSnNvbiB9IGZyb20gJy4uL3V0aWwvcmVhZC1wYWNrYWdlLWpzb24nO1xuaW1wb3J0IHJlYnVpbGRIb29rIGZyb20gJy4uL3V0aWwvcmVidWlsZCc7XG5pbXBvcnQgcmVxdWlyZVNlYXJjaCBmcm9tICcuLi91dGlsL3JlcXVpcmUtc2VhcmNoJztcbmltcG9ydCByZXNvbHZlRGlyIGZyb20gJy4uL3V0aWwvcmVzb2x2ZS1kaXInO1xuaW1wb3J0IGdldEN1cnJlbnRPdXREaXIgZnJvbSAnLi4vdXRpbC9vdXQtZGlyJztcbmltcG9ydCB7IGdldEVsZWN0cm9uVmVyc2lvbiB9IGZyb20gJy4uL3V0aWwvZWxlY3Ryb24tdmVyc2lvbic7XG5cbmNvbnN0IGQgPSBkZWJ1ZygnZWxlY3Ryb24tZm9yZ2U6cGFja2FnZXInKTtcblxudHlwZSBFbGVjdHJvblBhY2thZ2VyQWZ0ZXJDb3B5SG9vayA9IChcbiAgYnVpbGRQYXRoOiBzdHJpbmcsXG4gIGVsZWN0cm9uVmVyc2lvbjogc3RyaW5nLFxuICBwUGxhdGZvcm06IEZvcmdlUGxhdGZvcm0sXG4gIHBBcmNoOiBGb3JnZUFyY2gsXG4gIGRvbmU6IChlcnI/OiBFcnJvcikgPT4gdm9pZFxuKSA9PiB2b2lkO1xuXG4vKipcbiAqIFJlc29sdmVzIGhvb2tzIGlmIHRoZXkgYXJlIGEgcGF0aCB0byBhIGZpbGUgKGluc3RlYWQgb2YgYSBgRnVuY3Rpb25gKS5cbiAqL1xuZnVuY3Rpb24gcmVzb2x2ZUhvb2tzKGhvb2tzOiAoc3RyaW5nIHwgRWxlY3Ryb25QYWNrYWdlckFmdGVyQ29weUhvb2spW10gfCB1bmRlZmluZWQsIGRpcjogc3RyaW5nKSB7XG4gIGlmIChob29rcykge1xuICAgIHJldHVybiBob29rcy5tYXAoKGhvb2spID0+IChcbiAgICAgIHR5cGVvZiBob29rID09PSAnc3RyaW5nJ1xuICAgICAgICA/IHJlcXVpcmVTZWFyY2g8RWxlY3Ryb25QYWNrYWdlckFmdGVyQ29weUhvb2s+KGRpciwgW2hvb2tdKSBhcyBFbGVjdHJvblBhY2thZ2VyQWZ0ZXJDb3B5SG9va1xuICAgICAgICA6IGhvb2tcbiAgICApKTtcbiAgfVxuXG4gIHJldHVybiBbXTtcbn1cblxuLyoqXG4gKiBSdW5zIGdpdmVuIGhvb2tzIHNlcXVlbnRpYWxseSBieSBtYXBwaW5nIHRoZW0gdG8gcHJvbWlzZXMgYW5kIGl0ZXJhdGluZ1xuICogdGhyb3VnaCB3aGlsZSBhd2FpdGluZ1xuICovXG5mdW5jdGlvbiBzZXF1ZW50aWFsSG9va3MoaG9va3M6IEZ1bmN0aW9uW10pIHtcbiAgcmV0dXJuIFthc3luYyAoLi4uYXJnczogYW55W10pID0+IHtcbiAgICBjb25zdCBkb25lID0gYXJnc1thcmdzLmxlbmd0aCAtIDFdO1xuICAgIGNvbnN0IHBhc3NlZEFyZ3MgPSBhcmdzLnNwbGljZSgwLCBhcmdzLmxlbmd0aCAtIDEpO1xuICAgIGZvciAoY29uc3QgaG9vayBvZiBob29rcykge1xuICAgICAgYXdhaXQgcHJvbWlzaWZ5KGhvb2spKC4uLnBhc3NlZEFyZ3MpO1xuICAgIH1cbiAgICBkb25lKCk7XG4gIH1dIGFzIFsoLi4uYXJnczogYW55W10pID0+IFByb21pc2U8dm9pZD5dO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFBhY2thZ2VPcHRpb25zIHtcbiAgLyoqXG4gICAqIFRoZSBwYXRoIHRvIHRoZSBhcHAgdG8gcGFja2FnZVxuICAgKi9cbiAgZGlyPzogc3RyaW5nO1xuICAvKipcbiAgICogV2hldGhlciB0byB1c2Ugc2Vuc2libGUgZGVmYXVsdHMgb3IgcHJvbXB0IHRoZSB1c2VyIHZpc3VhbGx5XG4gICAqL1xuICBpbnRlcmFjdGl2ZT86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBUaGUgdGFyZ2V0IGFyY2hcbiAgICovXG4gIGFyY2g/OiBGb3JnZUFyY2g7XG4gIC8qKlxuICAgKiBUaGUgdGFyZ2V0IHBsYXRmb3JtLlxuICAgKi9cbiAgcGxhdGZvcm0/OiBGb3JnZVBsYXRmb3JtO1xuICAvKipcbiAgICogVGhlIHBhdGggdG8gdGhlIG91dHB1dCBkaXJlY3RvcnkgZm9yIHBhY2thZ2VkIGFwcHNcbiAgICovXG4gIG91dERpcj86IHN0cmluZztcbn1cblxuZXhwb3J0IGRlZmF1bHQgYXN5bmMgKHtcbiAgZGlyID0gcHJvY2Vzcy5jd2QoKSxcbiAgaW50ZXJhY3RpdmUgPSBmYWxzZSxcbiAgYXJjaCA9IGdldEhvc3RBcmNoKCkgYXMgRm9yZ2VBcmNoLFxuICBwbGF0Zm9ybSA9IHByb2Nlc3MucGxhdGZvcm0gYXMgRm9yZ2VQbGF0Zm9ybSxcbiAgb3V0RGlyLFxufTogUGFja2FnZU9wdGlvbnMpID0+IHtcbiAgY29uc3Qgb3JhID0gaW50ZXJhY3RpdmUgPyByZWFsT3JhIDogZmFrZU9yYTtcblxuICBsZXQgcHJlcGFyZVNwaW5uZXIgPSBvcmEoYFByZXBhcmluZyB0byBQYWNrYWdlIEFwcGxpY2F0aW9uIGZvciBhcmNoOiAkeyhhcmNoID09PSAnYWxsJyA/ICdpYTMyJyA6IGFyY2gpLmN5YW59YCkuc3RhcnQoKTtcbiAgbGV0IHByZXBhcmVDb3VudGVyID0gMDtcblxuICBjb25zdCByZXNvbHZlZERpciA9IGF3YWl0IHJlc29sdmVEaXIoZGlyKTtcbiAgaWYgKCFyZXNvbHZlZERpcikge1xuICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIGxvY2F0ZSBjb21waWxhYmxlIEVsZWN0cm9uIGFwcGxpY2F0aW9uJyk7XG4gIH1cbiAgZGlyID0gcmVzb2x2ZWREaXI7XG5cbiAgY29uc3QgZm9yZ2VDb25maWcgPSBhd2FpdCBnZXRGb3JnZUNvbmZpZyhkaXIpO1xuICBjb25zdCBwYWNrYWdlSlNPTiA9IGF3YWl0IHJlYWRNdXRhdGVkUGFja2FnZUpzb24oZGlyLCBmb3JnZUNvbmZpZyk7XG5cbiAgaWYgKCFwYWNrYWdlSlNPTi5tYWluKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdwYWNrYWdlSlNPTi5tYWluIG11c3QgYmUgc2V0IHRvIGEgdmFsaWQgZW50cnkgcG9pbnQgZm9yIHlvdXIgRWxlY3Ryb24gYXBwJyk7XG4gIH1cblxuICBjb25zdCBjYWxjdWxhdGVkT3V0RGlyID0gb3V0RGlyIHx8IGdldEN1cnJlbnRPdXREaXIoZGlyLCBmb3JnZUNvbmZpZyk7XG4gIGxldCBwYWNrYWdlclNwaW5uZXI6IE9yYUltcGwgfCBudWxsID0gbnVsbDtcblxuICBjb25zdCBwcnVuZUVuYWJsZWQgPSAhKCdwcnVuZScgaW4gZm9yZ2VDb25maWcucGFja2FnZXJDb25maWcpIHx8IGZvcmdlQ29uZmlnLnBhY2thZ2VyQ29uZmlnLnBydW5lO1xuXG4gIGNvbnN0IGFmdGVyQ29weUhvb2tzOiBFbGVjdHJvblBhY2thZ2VyQWZ0ZXJDb3B5SG9va1tdID0gW1xuICAgIGFzeW5jIChidWlsZFBhdGgsIGVsZWN0cm9uVmVyc2lvbiwgcFBsYXRmb3JtLCBwQXJjaCwgZG9uZSkgPT4ge1xuICAgICAgaWYgKHBhY2thZ2VyU3Bpbm5lcikge1xuICAgICAgICBwYWNrYWdlclNwaW5uZXIuc3VjY2VlZCgpO1xuICAgICAgICBwcmVwYXJlQ291bnRlciArPSAxO1xuICAgICAgICBwcmVwYXJlU3Bpbm5lciA9IG9yYShgUHJlcGFyaW5nIHRvIFBhY2thZ2UgQXBwbGljYXRpb24gZm9yIGFyY2g6ICR7KHByZXBhcmVDb3VudGVyID09PSAyID8gJ2FybXY3bCcgOiAneDY0JykuY3lhbn1gKS5zdGFydCgpO1xuICAgICAgfVxuICAgICAgY29uc3QgYmlucyA9IGF3YWl0IHByb21pc2lmeShnbG9iKShwYXRoLmpvaW4oYnVpbGRQYXRoLCAnKiovLmJpbi8qKi8qJykpO1xuICAgICAgZm9yIChjb25zdCBiaW4gb2YgYmlucykge1xuICAgICAgICBhd2FpdCBmcy5yZW1vdmUoYmluKTtcbiAgICAgIH1cbiAgICAgIGRvbmUoKTtcbiAgICB9LCBhc3luYyAoYnVpbGRQYXRoLCBlbGVjdHJvblZlcnNpb24sIHBQbGF0Zm9ybSwgcEFyY2gsIGRvbmUpID0+IHtcbiAgICAgIHByZXBhcmVTcGlubmVyLnN1Y2NlZWQoKTtcbiAgICAgIGF3YWl0IHJ1bkhvb2soZm9yZ2VDb25maWcsICdwYWNrYWdlQWZ0ZXJDb3B5JywgYnVpbGRQYXRoLCBlbGVjdHJvblZlcnNpb24sIHBQbGF0Zm9ybSwgcEFyY2gpO1xuICAgICAgZG9uZSgpO1xuICAgIH0sXG4gICAgYXN5bmMgKGJ1aWxkUGF0aCwgZWxlY3Ryb25WZXJzaW9uLCBwUGxhdGZvcm0sIHBBcmNoLCBkb25lKSA9PiB7XG4gICAgICBhd2FpdCByZWJ1aWxkSG9vayhcbiAgICAgICAgYnVpbGRQYXRoLFxuICAgICAgICBlbGVjdHJvblZlcnNpb24sXG4gICAgICAgIHBQbGF0Zm9ybSxcbiAgICAgICAgcEFyY2gsXG4gICAgICAgIGZvcmdlQ29uZmlnLmVsZWN0cm9uUmVidWlsZENvbmZpZyxcbiAgICAgICk7XG4gICAgICBwYWNrYWdlclNwaW5uZXIgPSBvcmEoJ1BhY2thZ2luZyBBcHBsaWNhdGlvbicpLnN0YXJ0KCk7XG4gICAgICBkb25lKCk7XG4gICAgfSxcbiAgXTtcblxuICBhZnRlckNvcHlIb29rcy5wdXNoKGFzeW5jIChidWlsZFBhdGgsIGVsZWN0cm9uVmVyc2lvbiwgcFBsYXRmb3JtLCBwQXJjaCwgZG9uZSkgPT4ge1xuICAgIGNvbnN0IGNvcGllZFBhY2thZ2VKU09OID0gYXdhaXQgcmVhZE11dGF0ZWRQYWNrYWdlSnNvbihidWlsZFBhdGgsIGZvcmdlQ29uZmlnKTtcbiAgICBpZiAoY29waWVkUGFja2FnZUpTT04uY29uZmlnICYmIGNvcGllZFBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZSkge1xuICAgICAgZGVsZXRlIGNvcGllZFBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZTtcbiAgICB9XG4gICAgYXdhaXQgZnMud3JpdGVKc29uKHBhdGgucmVzb2x2ZShidWlsZFBhdGgsICdwYWNrYWdlLmpzb24nKSwgY29waWVkUGFja2FnZUpTT04sIHsgc3BhY2VzOiAyIH0pO1xuICAgIGRvbmUoKTtcbiAgfSk7XG5cbiAgYWZ0ZXJDb3B5SG9va3MucHVzaCguLi5yZXNvbHZlSG9va3MoZm9yZ2VDb25maWcucGFja2FnZXJDb25maWcuYWZ0ZXJDb3B5LCBkaXIpKTtcblxuICBjb25zdCBhZnRlclBydW5lSG9va3MgPSBbXTtcblxuICBpZiAocHJ1bmVFbmFibGVkKSB7XG4gICAgYWZ0ZXJQcnVuZUhvb2tzLnB1c2goLi4ucmVzb2x2ZUhvb2tzKGZvcmdlQ29uZmlnLnBhY2thZ2VyQ29uZmlnLmFmdGVyUHJ1bmUsIGRpcikpO1xuICB9XG5cbiAgYWZ0ZXJQcnVuZUhvb2tzLnB1c2goKGFzeW5jIChidWlsZFBhdGgsIGVsZWN0cm9uVmVyc2lvbiwgcFBsYXRmb3JtLCBwQXJjaCwgZG9uZSkgPT4ge1xuICAgIGF3YWl0IHJ1bkhvb2soZm9yZ2VDb25maWcsICdwYWNrYWdlQWZ0ZXJQcnVuZScsIGJ1aWxkUGF0aCwgZWxlY3Ryb25WZXJzaW9uLCBwUGxhdGZvcm0sIHBBcmNoKTtcbiAgICBkb25lKCk7XG4gIH0pIGFzIEVsZWN0cm9uUGFja2FnZXJBZnRlckNvcHlIb29rKTtcblxuICBjb25zdCBhZnRlckV4dHJhY3RIb29rcyA9IFsoYXN5bmMgKGJ1aWxkUGF0aCwgZWxlY3Ryb25WZXJzaW9uLCBwUGxhdGZvcm0sIHBBcmNoLCBkb25lKSA9PiB7XG4gICAgYXdhaXQgcnVuSG9vayhmb3JnZUNvbmZpZywgJ3BhY2thZ2VBZnRlckV4dHJhY3QnLCBidWlsZFBhdGgsIGVsZWN0cm9uVmVyc2lvbiwgcFBsYXRmb3JtLCBwQXJjaCk7XG4gICAgZG9uZSgpO1xuICB9KSBhcyBFbGVjdHJvblBhY2thZ2VyQWZ0ZXJDb3B5SG9va107XG4gIGFmdGVyRXh0cmFjdEhvb2tzLnB1c2goLi4ucmVzb2x2ZUhvb2tzKGZvcmdlQ29uZmlnLnBhY2thZ2VyQ29uZmlnLmFmdGVyRXh0cmFjdCwgZGlyKSk7XG5cbiAgdHlwZSBQYWNrYWdlckFyY2ggPSBFeGNsdWRlPEZvcmdlQXJjaCwgJ2FybSc+O1xuXG4gIGNvbnN0IHBhY2thZ2VPcHRzOiBwYWNrYWdlci5PcHRpb25zID0ge1xuICAgIGFzYXI6IGZhbHNlLFxuICAgIG92ZXJ3cml0ZTogdHJ1ZSxcbiAgICAuLi5mb3JnZUNvbmZpZy5wYWNrYWdlckNvbmZpZyxcbiAgICBkaXIsXG4gICAgYXJjaDogYXJjaCBhcyBQYWNrYWdlckFyY2gsXG4gICAgcGxhdGZvcm0sXG4gICAgYWZ0ZXJDb3B5OiBzZXF1ZW50aWFsSG9va3MoYWZ0ZXJDb3B5SG9va3MpLFxuICAgIGFmdGVyRXh0cmFjdDogc2VxdWVudGlhbEhvb2tzKGFmdGVyRXh0cmFjdEhvb2tzKSxcbiAgICBhZnRlclBydW5lOiBzZXF1ZW50aWFsSG9va3MoYWZ0ZXJQcnVuZUhvb2tzKSxcbiAgICBvdXQ6IGNhbGN1bGF0ZWRPdXREaXIsXG4gICAgZWxlY3Ryb25WZXJzaW9uOiBhd2FpdCBnZXRFbGVjdHJvblZlcnNpb24oZGlyLCBwYWNrYWdlSlNPTiksXG4gIH07XG4gIHBhY2thZ2VPcHRzLnF1aWV0ID0gdHJ1ZTtcblxuICBpZiAocGFja2FnZU9wdHMuYWxsKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdjb25maWcuZm9yZ2UucGFja2FnZXJDb25maWcuYWxsIGlzIG5vdCBzdXBwb3J0ZWQgYnkgRWxlY3Ryb24gRm9yZ2UnKTtcbiAgfVxuXG4gIGlmICghcGFja2FnZUpTT04udmVyc2lvbiAmJiAhcGFja2FnZU9wdHMuYXBwVmVyc2lvbikge1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBtYXgtbGVuXG4gICAgd2FybihpbnRlcmFjdGl2ZSwgJ1BsZWFzZSBzZXQgXCJ2ZXJzaW9uXCIgb3IgXCJjb25maWcuZm9yZ2UucGFja2FnZXJDb25maWcuYXBwVmVyc2lvblwiIGluIHlvdXIgYXBwbGljYXRpb25cXCdzIHBhY2thZ2UuanNvbiBzbyBhdXRvLXVwZGF0ZXMgd29yayBwcm9wZXJseScueWVsbG93KTtcbiAgfVxuXG4gIGlmIChwYWNrYWdlT3B0cy5wcmVidWlsdEFzYXIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ2NvbmZpZy5mb3JnZS5wYWNrYWdlckNvbmZpZy5wcmVidWlsdEFzYXIgaXMgbm90IHN1cHBvcnRlZCBieSBFbGVjdHJvbiBGb3JnZScpO1xuICB9XG5cbiAgYXdhaXQgcnVuSG9vayhmb3JnZUNvbmZpZywgJ2dlbmVyYXRlQXNzZXRzJyk7XG4gIGF3YWl0IHJ1bkhvb2soZm9yZ2VDb25maWcsICdwcmVQYWNrYWdlJyk7XG5cbiAgZCgncGFja2FnaW5nIHdpdGggb3B0aW9ucycsIHBhY2thZ2VPcHRzKTtcblxuICBhd2FpdCBwYWNrYWdlcihwYWNrYWdlT3B0cyk7XG5cbiAgYXdhaXQgcnVuSG9vayhmb3JnZUNvbmZpZywgJ3Bvc3RQYWNrYWdlJyk7XG5cbiAgaWYgKHBhY2thZ2VyU3Bpbm5lcikgcGFja2FnZXJTcGlubmVyIS5zdWNjZWVkKCk7XG59O1xuIl19