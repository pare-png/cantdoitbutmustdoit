"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.setInitialForgeConfig = setInitialForgeConfig;
exports.fromBuildIdentifier = fromBuildIdentifier;
exports.default = void 0;

require("source-map-support/register");

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _path = _interopRequireDefault(require("path"));

var _lodash = _interopRequireDefault(require("lodash.template"));

var _readPackageJson = require("./read-package-json");

var _pluginInterface = _interopRequireDefault(require("./plugin-interface"));

var _hook = require("./hook");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const underscoreCase = str => str.replace(/(.)([A-Z][a-z]+)/g, '$1_$2').replace(/([a-z0-9])([A-Z])/g, '$1_$2').toUpperCase(); // eslint-disable-next-line arrow-parens


const proxify = (buildIdentifier, object, envPrefix) => {
  let newObject = {};

  if (Array.isArray(object)) {
    newObject = [];
  }

  Object.keys(object).forEach(key => {
    const val = object[key];

    if (typeof val === 'object' && key !== 'pluginInterface' && !(val instanceof RegExp)) {
      newObject[key] = proxify(buildIdentifier, object[key], `${envPrefix}_${underscoreCase(key)}`);
    } else {
      newObject[key] = object[key];
    }
  });
  return new Proxy(newObject, {
    get(target, name, receiver) {
      // eslint-disable-next-line no-prototype-builtins
      if (!target.hasOwnProperty(name) && typeof name === 'string') {
        const envValue = process.env[`${envPrefix}_${underscoreCase(name)}`];
        if (envValue) return envValue;
      }

      const value = Reflect.get(target, name, receiver); // eslint-disable-next-line no-underscore-dangle

      if (value && typeof value === 'object' && value.__isMagicBuildIdentifierMap) {
        const identifier = typeof buildIdentifier === 'function' ? buildIdentifier() : buildIdentifier;
        return value.map[identifier];
      }

      return value;
    },

    getOwnPropertyDescriptor(target, name) {
      const envValue = process.env[`${envPrefix}_${underscoreCase(name)}`]; // eslint-disable-next-line no-prototype-builtins

      if (target.hasOwnProperty(name)) {
        return Reflect.getOwnPropertyDescriptor(target, name);
      }

      if (envValue) {
        return {
          writable: true,
          enumerable: true,
          configurable: true,
          value: envValue
        };
      }

      return undefined;
    }

  });
};
/**
 * Sets sensible defaults for the `config.forge` object.
 */


function setInitialForgeConfig(packageJSON) {
  const {
    name = ''
  } = packageJSON;
  packageJSON.config.forge.makers[0].config.name = name.replace(/-/g, '_');
}

function fromBuildIdentifier(map) {
  return {
    map,
    __isMagicBuildIdentifierMap: true
  };
}

async function forgeConfigIsValidFilePath(dir, forgeConfig) {
  return typeof forgeConfig === 'string' && ((await _fsExtra.default.pathExists(_path.default.resolve(dir, forgeConfig))) || _fsExtra.default.pathExists(_path.default.resolve(dir, `${forgeConfig}.js`)));
}

var _default = async dir => {
  const packageJSON = await (0, _readPackageJson.readRawPackageJson)(dir);
  let forgeConfig = packageJSON.config && packageJSON.config.forge ? packageJSON.config.forge : null;

  if (!forgeConfig) {
    if (await _fsExtra.default.pathExists(_path.default.resolve(dir, 'forge.config.js'))) {
      forgeConfig = 'forge.config.js';
    } else {
      forgeConfig = {};
    }
  }

  if (await forgeConfigIsValidFilePath(dir, forgeConfig)) {
    try {
      // eslint-disable-next-line global-require, import/no-dynamic-require
      forgeConfig = require(_path.default.resolve(dir, forgeConfig));
    } catch (err) {
      // eslint-disable-next-line no-console
      console.error(`Failed to load: ${_path.default.resolve(dir, forgeConfig)}`);
      throw err;
    }
  } else if (typeof forgeConfig !== 'object') {
    throw new Error('Expected packageJSON.config.forge to be an object or point to a requirable JS file');
  }

  forgeConfig = _objectSpread({
    electronRebuildConfig: {},
    packagerConfig: {},
    makers: [],
    publishers: [],
    plugins: []
  }, forgeConfig);

  const templateObj = _objectSpread({}, packageJSON, {
    year: new Date().getFullYear()
  });

  const template = obj => {
    Object.keys(obj).forEach(objKey => {
      if (typeof obj[objKey] === 'object' && obj !== null) {
        template(obj[objKey]);
      } else if (typeof obj[objKey] === 'string') {
        obj[objKey] = (0, _lodash.default)(obj[objKey])(templateObj);

        if (obj[objKey].startsWith('require:')) {
          // eslint-disable-next-line global-require, import/no-dynamic-require
          obj[objKey] = require(_path.default.resolve(dir, obj[objKey].substr(8)));
        }
      }
    });
  };

  template(forgeConfig);
  forgeConfig.pluginInterface = new _pluginInterface.default(dir, forgeConfig);
  forgeConfig = await (0, _hook.runMutatingHook)(forgeConfig, 'resolveForgeConfig', forgeConfig);
  return proxify(forgeConfig.buildIdentifier || '', forgeConfig, 'ELECTRON_FORGE');
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL2ZvcmdlLWNvbmZpZy50cyJdLCJuYW1lcyI6WyJ1bmRlcnNjb3JlQ2FzZSIsInN0ciIsInJlcGxhY2UiLCJ0b1VwcGVyQ2FzZSIsInByb3hpZnkiLCJidWlsZElkZW50aWZpZXIiLCJvYmplY3QiLCJlbnZQcmVmaXgiLCJuZXdPYmplY3QiLCJBcnJheSIsImlzQXJyYXkiLCJPYmplY3QiLCJrZXlzIiwiZm9yRWFjaCIsImtleSIsInZhbCIsIlJlZ0V4cCIsIlByb3h5IiwiZ2V0IiwidGFyZ2V0IiwibmFtZSIsInJlY2VpdmVyIiwiaGFzT3duUHJvcGVydHkiLCJlbnZWYWx1ZSIsInByb2Nlc3MiLCJlbnYiLCJ2YWx1ZSIsIlJlZmxlY3QiLCJfX2lzTWFnaWNCdWlsZElkZW50aWZpZXJNYXAiLCJpZGVudGlmaWVyIiwibWFwIiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwid3JpdGFibGUiLCJlbnVtZXJhYmxlIiwiY29uZmlndXJhYmxlIiwidW5kZWZpbmVkIiwic2V0SW5pdGlhbEZvcmdlQ29uZmlnIiwicGFja2FnZUpTT04iLCJjb25maWciLCJmb3JnZSIsIm1ha2VycyIsImZyb21CdWlsZElkZW50aWZpZXIiLCJmb3JnZUNvbmZpZ0lzVmFsaWRGaWxlUGF0aCIsImRpciIsImZvcmdlQ29uZmlnIiwiZnMiLCJwYXRoRXhpc3RzIiwicGF0aCIsInJlc29sdmUiLCJyZXF1aXJlIiwiZXJyIiwiY29uc29sZSIsImVycm9yIiwiRXJyb3IiLCJlbGVjdHJvblJlYnVpbGRDb25maWciLCJwYWNrYWdlckNvbmZpZyIsInB1Ymxpc2hlcnMiLCJwbHVnaW5zIiwidGVtcGxhdGVPYmoiLCJ5ZWFyIiwiRGF0ZSIsImdldEZ1bGxZZWFyIiwidGVtcGxhdGUiLCJvYmoiLCJvYmpLZXkiLCJzdGFydHNXaXRoIiwic3Vic3RyIiwicGx1Z2luSW50ZXJmYWNlIiwiUGx1Z2luSW50ZXJmYWNlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUNB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cmdlQ29uZmlnIH0gZnJvbSAnQGVsZWN0cm9uLWZvcmdlL3NoYXJlZC10eXBlcyc7XG5pbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgX3RlbXBsYXRlIGZyb20gJ2xvZGFzaC50ZW1wbGF0ZSc7XG5cbmltcG9ydCB7IHJlYWRSYXdQYWNrYWdlSnNvbiB9IGZyb20gJy4vcmVhZC1wYWNrYWdlLWpzb24nO1xuaW1wb3J0IFBsdWdpbkludGVyZmFjZSBmcm9tICcuL3BsdWdpbi1pbnRlcmZhY2UnO1xuaW1wb3J0IHsgcnVuTXV0YXRpbmdIb29rIH0gZnJvbSAnLi9ob29rJztcblxuY29uc3QgdW5kZXJzY29yZUNhc2UgPSAoc3RyOiBzdHJpbmcpID0+IHN0ci5yZXBsYWNlKC8oLikoW0EtWl1bYS16XSspL2csICckMV8kMicpLnJlcGxhY2UoLyhbYS16MC05XSkoW0EtWl0pL2csICckMV8kMicpLnRvVXBwZXJDYXNlKCk7XG5cbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBhcnJvdy1wYXJlbnNcbmNvbnN0IHByb3hpZnkgPSA8VCBleHRlbmRzIG9iamVjdD4oXG4gIGJ1aWxkSWRlbnRpZmllcjogc3RyaW5nIHwgKCgpID0+IHN0cmluZyksXG4gIG9iamVjdDogVCxcbiAgZW52UHJlZml4OiBzdHJpbmcsXG4pOiBUID0+IHtcbiAgbGV0IG5ld09iamVjdDogVCA9IHt9IGFzIGFueTtcbiAgaWYgKEFycmF5LmlzQXJyYXkob2JqZWN0KSkge1xuICAgIG5ld09iamVjdCA9IFtdIGFzIGFueTtcbiAgfVxuXG4gIE9iamVjdC5rZXlzKG9iamVjdCkuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgY29uc3QgdmFsID0gKG9iamVjdCBhcyBhbnkpW2tleV07XG4gICAgaWYgKHR5cGVvZiB2YWwgPT09ICdvYmplY3QnICYmIGtleSAhPT0gJ3BsdWdpbkludGVyZmFjZScgJiYgISh2YWwgaW5zdGFuY2VvZiBSZWdFeHApKSB7XG4gICAgICAobmV3T2JqZWN0IGFzIGFueSlba2V5XSA9IHByb3hpZnkoYnVpbGRJZGVudGlmaWVyLCAob2JqZWN0IGFzIGFueSlba2V5XSwgYCR7ZW52UHJlZml4fV8ke3VuZGVyc2NvcmVDYXNlKGtleSl9YCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIChuZXdPYmplY3QgYXMgYW55KVtrZXldID0gKG9iamVjdCBhcyBhbnkpW2tleV07XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gbmV3IFByb3h5PFQ+KG5ld09iamVjdCwge1xuICAgIGdldCh0YXJnZXQsIG5hbWUsIHJlY2VpdmVyKSB7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tcHJvdG90eXBlLWJ1aWx0aW5zXG4gICAgICBpZiAoIXRhcmdldC5oYXNPd25Qcm9wZXJ0eShuYW1lKSAmJiB0eXBlb2YgbmFtZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgY29uc3QgZW52VmFsdWUgPSBwcm9jZXNzLmVudltgJHtlbnZQcmVmaXh9XyR7dW5kZXJzY29yZUNhc2UobmFtZSl9YF07XG4gICAgICAgIGlmIChlbnZWYWx1ZSkgcmV0dXJuIGVudlZhbHVlO1xuICAgICAgfVxuICAgICAgY29uc3QgdmFsdWUgPSBSZWZsZWN0LmdldCh0YXJnZXQsIG5hbWUsIHJlY2VpdmVyKTtcblxuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVuZGVyc2NvcmUtZGFuZ2xlXG4gICAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJiB2YWx1ZS5fX2lzTWFnaWNCdWlsZElkZW50aWZpZXJNYXApIHtcbiAgICAgICAgY29uc3QgaWRlbnRpZmllciA9IHR5cGVvZiBidWlsZElkZW50aWZpZXIgPT09ICdmdW5jdGlvbicgPyBidWlsZElkZW50aWZpZXIoKSA6IGJ1aWxkSWRlbnRpZmllcjtcbiAgICAgICAgcmV0dXJuIHZhbHVlLm1hcFtpZGVudGlmaWVyXTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9LFxuICAgIGdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIG5hbWUpIHtcbiAgICAgIGNvbnN0IGVudlZhbHVlID0gcHJvY2Vzcy5lbnZbYCR7ZW52UHJlZml4fV8ke3VuZGVyc2NvcmVDYXNlKG5hbWUgYXMgc3RyaW5nKX1gXTtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1wcm90b3R5cGUtYnVpbHRpbnNcbiAgICAgIGlmICh0YXJnZXQuaGFzT3duUHJvcGVydHkobmFtZSkpIHtcbiAgICAgICAgcmV0dXJuIFJlZmxlY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwgbmFtZSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChlbnZWYWx1ZSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLFxuICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsXG4gICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICAgIHZhbHVlOiBlbnZWYWx1ZSxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9LFxuICB9KTtcbn07XG5cbi8qKlxuICogU2V0cyBzZW5zaWJsZSBkZWZhdWx0cyBmb3IgdGhlIGBjb25maWcuZm9yZ2VgIG9iamVjdC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNldEluaXRpYWxGb3JnZUNvbmZpZyhwYWNrYWdlSlNPTjogYW55KSB7XG4gIGNvbnN0IHsgbmFtZSA9ICcnIH0gPSBwYWNrYWdlSlNPTjtcblxuICBwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UubWFrZXJzWzBdLmNvbmZpZy5uYW1lID0gbmFtZS5yZXBsYWNlKC8tL2csICdfJyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmcm9tQnVpbGRJZGVudGlmaWVyPFQ+KG1hcDogeyBba2V5OiBzdHJpbmddOiBUIHwgdW5kZWZpbmVkIH0pIHtcbiAgcmV0dXJuIHtcbiAgICBtYXAsXG4gICAgX19pc01hZ2ljQnVpbGRJZGVudGlmaWVyTWFwOiB0cnVlLFxuICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBmb3JnZUNvbmZpZ0lzVmFsaWRGaWxlUGF0aChkaXI6IHN0cmluZywgZm9yZ2VDb25maWc6IHN0cmluZyB8IEZvcmdlQ29uZmlnKSB7XG4gIHJldHVybiB0eXBlb2YgZm9yZ2VDb25maWcgPT09ICdzdHJpbmcnXG4gICAgJiYgKFxuICAgICAgYXdhaXQgZnMucGF0aEV4aXN0cyhwYXRoLnJlc29sdmUoZGlyLCBmb3JnZUNvbmZpZykpXG4gICAgICB8fCBmcy5wYXRoRXhpc3RzKHBhdGgucmVzb2x2ZShkaXIsIGAke2ZvcmdlQ29uZmlnfS5qc2ApKVxuICAgICk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGFzeW5jIChkaXI6IHN0cmluZykgPT4ge1xuICBjb25zdCBwYWNrYWdlSlNPTiA9IGF3YWl0IHJlYWRSYXdQYWNrYWdlSnNvbihkaXIpO1xuICBsZXQgZm9yZ2VDb25maWc6IEZvcmdlQ29uZmlnIHwgc3RyaW5nIHwgbnVsbCA9IChwYWNrYWdlSlNPTi5jb25maWcgJiYgcGFja2FnZUpTT04uY29uZmlnLmZvcmdlKVxuICAgID8gcGFja2FnZUpTT04uY29uZmlnLmZvcmdlXG4gICAgOiBudWxsO1xuXG4gIGlmICghZm9yZ2VDb25maWcpIHtcbiAgICBpZiAoYXdhaXQgZnMucGF0aEV4aXN0cyhwYXRoLnJlc29sdmUoZGlyLCAnZm9yZ2UuY29uZmlnLmpzJykpKSB7XG4gICAgICBmb3JnZUNvbmZpZyA9ICdmb3JnZS5jb25maWcuanMnO1xuICAgIH0gZWxzZSB7XG4gICAgICBmb3JnZUNvbmZpZyA9IHt9IGFzIGFueSBhcyBGb3JnZUNvbmZpZztcbiAgICB9XG4gIH1cblxuICBpZiAoYXdhaXQgZm9yZ2VDb25maWdJc1ZhbGlkRmlsZVBhdGgoZGlyLCBmb3JnZUNvbmZpZykpIHtcbiAgICB0cnkge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGdsb2JhbC1yZXF1aXJlLCBpbXBvcnQvbm8tZHluYW1pYy1yZXF1aXJlXG4gICAgICBmb3JnZUNvbmZpZyA9IHJlcXVpcmUocGF0aC5yZXNvbHZlKGRpciwgZm9yZ2VDb25maWcgYXMgc3RyaW5nKSkgYXMgRm9yZ2VDb25maWc7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICAgICAgY29uc29sZS5lcnJvcihgRmFpbGVkIHRvIGxvYWQ6ICR7cGF0aC5yZXNvbHZlKGRpciwgZm9yZ2VDb25maWcgYXMgc3RyaW5nKX1gKTtcbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gIH0gZWxzZSBpZiAodHlwZW9mIGZvcmdlQ29uZmlnICE9PSAnb2JqZWN0Jykge1xuICAgIHRocm93IG5ldyBFcnJvcignRXhwZWN0ZWQgcGFja2FnZUpTT04uY29uZmlnLmZvcmdlIHRvIGJlIGFuIG9iamVjdCBvciBwb2ludCB0byBhIHJlcXVpcmFibGUgSlMgZmlsZScpO1xuICB9XG4gIGZvcmdlQ29uZmlnID0ge1xuICAgIGVsZWN0cm9uUmVidWlsZENvbmZpZzoge30sXG4gICAgcGFja2FnZXJDb25maWc6IHt9LFxuICAgIG1ha2VyczogW10sXG4gICAgcHVibGlzaGVyczogW10sXG4gICAgcGx1Z2luczogW10sXG4gICAgLi4uZm9yZ2VDb25maWcsXG4gIH07XG5cbiAgY29uc3QgdGVtcGxhdGVPYmogPSB7IC4uLnBhY2thZ2VKU09OLCB5ZWFyOiAobmV3IERhdGUoKSkuZ2V0RnVsbFllYXIoKSB9O1xuICBjb25zdCB0ZW1wbGF0ZSA9IChvYmo6IGFueSkgPT4ge1xuICAgIE9iamVjdC5rZXlzKG9iaikuZm9yRWFjaCgob2JqS2V5KSA9PiB7XG4gICAgICBpZiAodHlwZW9mIG9ialtvYmpLZXldID09PSAnb2JqZWN0JyAmJiBvYmogIT09IG51bGwpIHtcbiAgICAgICAgdGVtcGxhdGUob2JqW29iaktleV0pO1xuICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygb2JqW29iaktleV0gPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIG9ialtvYmpLZXldID0gX3RlbXBsYXRlKG9ialtvYmpLZXldKSh0ZW1wbGF0ZU9iaik7XG4gICAgICAgIGlmIChvYmpbb2JqS2V5XS5zdGFydHNXaXRoKCdyZXF1aXJlOicpKSB7XG4gICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGdsb2JhbC1yZXF1aXJlLCBpbXBvcnQvbm8tZHluYW1pYy1yZXF1aXJlXG4gICAgICAgICAgb2JqW29iaktleV0gPSByZXF1aXJlKHBhdGgucmVzb2x2ZShkaXIsIG9ialtvYmpLZXldLnN1YnN0cig4KSkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH07XG5cbiAgdGVtcGxhdGUoZm9yZ2VDb25maWcpO1xuXG4gIGZvcmdlQ29uZmlnLnBsdWdpbkludGVyZmFjZSA9IG5ldyBQbHVnaW5JbnRlcmZhY2UoZGlyLCBmb3JnZUNvbmZpZyk7XG5cbiAgZm9yZ2VDb25maWcgPSBhd2FpdCBydW5NdXRhdGluZ0hvb2soZm9yZ2VDb25maWcsICdyZXNvbHZlRm9yZ2VDb25maWcnLCBmb3JnZUNvbmZpZyk7XG5cbiAgcmV0dXJuIHByb3hpZnk8Rm9yZ2VDb25maWc+KGZvcmdlQ29uZmlnLmJ1aWxkSWRlbnRpZmllciB8fCAnJywgZm9yZ2VDb25maWcsICdFTEVDVFJPTl9GT1JHRScpO1xufTtcbiJdfQ==