"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _pluginBase = _interopRequireDefault(require("@electron-forge/plugin-base"));

var _debug = _interopRequireDefault(require("debug"));

var _requireSearch = _interopRequireDefault(require("./require-search"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const d = (0, _debug.default)('electron-forge:plugins');

class PluginInterface {
  constructor(dir, forgeConfig) {
    _defineProperty(this, "plugins", void 0);

    _defineProperty(this, "config", void 0);

    this.plugins = forgeConfig.plugins.map(plugin => {
      // eslint-disable-next-line no-underscore-dangle
      if (plugin.__isElectronForgePlugin) {
        return plugin;
      }

      if (Array.isArray(plugin)) {
        const [pluginName, opts = {}] = plugin;

        if (typeof pluginName !== 'string') {
          throw new Error(`Expected plugin[0] to be a string but found ${pluginName}`);
        }

        const Plugin = (0, _requireSearch.default)(dir, [pluginName]);

        if (!Plugin) {
          throw new Error(`Could not find module with name: ${plugin[0]}. Make sure it's listed in the devDependencies of your package.json`);
        }

        return new Plugin(opts);
      }

      throw new Error(`Expected plugin to either be a plugin instance or [string, object] but found ${plugin}`);
    }); // Fix linting

    this.config = null;
    Object.defineProperty(this, 'config', {
      value: forgeConfig,
      enumerable: false,
      configurable: false,
      writable: false
    });

    for (const plugin of this.plugins) {
      plugin.init(dir, forgeConfig);
    }

    this.triggerHook = this.triggerHook.bind(this);
    this.overrideStartLogic = this.overrideStartLogic.bind(this);
  }

  async triggerHook(hookName, hookArgs) {
    for (const plugin of this.plugins) {
      if (typeof plugin.getHook === 'function') {
        const hook = plugin.getHook(hookName);
        if (hook) await hook(this.config, ...hookArgs);
      }
    }
  }

  async triggerMutatingHook(hookName, item) {
    for (const plugin of this.plugins) {
      if (typeof plugin.getHook === 'function') {
        const hook = plugin.getHook(hookName);

        if (hook) {
          item = await hook(this.config, item);
        }
      }
    }

    return item;
  }

  async overrideStartLogic(opts) {
    let newStartFn;
    const claimed = [];

    for (const plugin of this.plugins) {
      if (typeof plugin.startLogic === 'function' && plugin.startLogic !== _pluginBase.default.prototype.startLogic) {
        claimed.push(plugin.name);
        newStartFn = plugin.startLogic;
      }
    }

    if (claimed.length > 1) {
      throw new Error(`Multiple plugins tried to take control of the start command, please remove one of them\n --> ${claimed.join(', ')}`);
    }

    if (claimed.length === 1 && newStartFn) {
      d(`plugin: "${claimed[0]}" has taken control of the start command`);
      return newStartFn(opts);
    }

    return false;
  }

}

exports.default = PluginInterface;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL3BsdWdpbi1pbnRlcmZhY2UudHMiXSwibmFtZXMiOlsiZCIsIlBsdWdpbkludGVyZmFjZSIsImNvbnN0cnVjdG9yIiwiZGlyIiwiZm9yZ2VDb25maWciLCJwbHVnaW5zIiwibWFwIiwicGx1Z2luIiwiX19pc0VsZWN0cm9uRm9yZ2VQbHVnaW4iLCJBcnJheSIsImlzQXJyYXkiLCJwbHVnaW5OYW1lIiwib3B0cyIsIkVycm9yIiwiUGx1Z2luIiwiY29uZmlnIiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJ2YWx1ZSIsImVudW1lcmFibGUiLCJjb25maWd1cmFibGUiLCJ3cml0YWJsZSIsImluaXQiLCJ0cmlnZ2VySG9vayIsImJpbmQiLCJvdmVycmlkZVN0YXJ0TG9naWMiLCJob29rTmFtZSIsImhvb2tBcmdzIiwiZ2V0SG9vayIsImhvb2siLCJ0cmlnZ2VyTXV0YXRpbmdIb29rIiwiaXRlbSIsIm5ld1N0YXJ0Rm4iLCJjbGFpbWVkIiwic3RhcnRMb2dpYyIsIlBsdWdpbkJhc2UiLCJwcm90b3R5cGUiLCJwdXNoIiwibmFtZSIsImxlbmd0aCIsImpvaW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUVBOztBQUdBOzs7Ozs7QUFFQSxNQUFNQSxDQUFDLEdBQUcsb0JBQU0sd0JBQU4sQ0FBVjs7QUFFZSxNQUFNQyxlQUFOLENBQXVEO0FBS3BFQyxFQUFBQSxXQUFXLENBQUNDLEdBQUQsRUFBY0MsV0FBZCxFQUF3QztBQUFBOztBQUFBOztBQUNqRCxTQUFLQyxPQUFMLEdBQWVELFdBQVcsQ0FBQ0MsT0FBWixDQUFvQkMsR0FBcEIsQ0FBeUJDLE1BQUQsSUFBWTtBQUNqRDtBQUNBLFVBQUtBLE1BQUQsQ0FBeUJDLHVCQUE3QixFQUFzRDtBQUNwRCxlQUFPRCxNQUFQO0FBQ0Q7O0FBRUQsVUFBSUUsS0FBSyxDQUFDQyxPQUFOLENBQWNILE1BQWQsQ0FBSixFQUEyQjtBQUN6QixjQUFNLENBQUNJLFVBQUQsRUFBYUMsSUFB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TSxDQUFDMkIsVUFBcEI7QUFDRDtBQUNGOztBQUNELFFBQUlELE9BQU8sQ0FBQ00sTUFBUixHQUFpQixDQUFyQixFQUF3QjtBQUN0QixZQUFNLElBQUkxQixLQUFKLENBQVcsZ0dBQStGb0IsT0FBTyxDQUFDTyxJQUFSLENBQWEsSUFBYixDQUFtQixFQUE3SCxDQUFOO0FBQ0Q7O0FBQ0QsUUFBSVAsT0FBTyxDQUFDTSxNQUFSLEtBQW1CLENBQW5CLElBQXdCUCxVQUE1QixFQUF3QztBQUN0Q2hDLE1BQUFBLENBQUMsQ0FBRSxZQUFXaUMsT0FBTyxDQUFDLENBQUQsQ0FBSSwwQ0FBeEIsQ0FBRDtBQUNBLGFBQU9ELFVBQVUsQ0FBQ3BCLElBQUQsQ0FBakI7QUFDRDs7QUFDRCxXQUFPLEtBQVA7QUFDRDs7QUFoRm1FIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFBsdWdpbkJhc2UgZnJvbSAnQGVsZWN0cm9uLWZvcmdlL3BsdWdpbi1iYXNlJztcbmltcG9ydCB7IElGb3JnZVBsdWdpbkludGVyZmFjZSwgRm9yZ2VDb25maWcsIElGb3JnZVBsdWdpbiB9IGZyb20gJ0BlbGVjdHJvbi1mb3JnZS9zaGFyZWQtdHlwZXMnO1xuaW1wb3J0IGRlYnVnIGZyb20gJ2RlYnVnJztcblxuaW1wb3J0IHsgU3RhcnRPcHRpb25zIH0gZnJvbSAnLi4vYXBpJztcbmltcG9ydCByZXF1aXJlU2VhcmNoIGZyb20gJy4vcmVxdWlyZS1zZWFyY2gnO1xuXG5jb25zdCBkID0gZGVidWcoJ2VsZWN0cm9uLWZvcmdlOnBsdWdpbnMnKTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUGx1Z2luSW50ZXJmYWNlIGltcGxlbWVudHMgSUZvcmdlUGx1Z2luSW50ZXJmYWNlIHtcbiAgcHJpdmF0ZSBwbHVnaW5zOiBJRm9yZ2VQbHVnaW5bXTtcblxuICBwcml2YXRlIGNvbmZpZzogRm9yZ2VDb25maWc7XG5cbiAgY29uc3RydWN0b3IoZGlyOiBzdHJpbmcsIGZvcmdlQ29uZmlnOiBGb3JnZUNvbmZpZykge1xuICAgIHRoaXMucGx1Z2lucyA9IGZvcmdlQ29uZmlnLnBsdWdpbnMubWFwKChwbHVnaW4pID0+IHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bmRlcnNjb3JlLWRhbmdsZVxuICAgICAgaWYgKChwbHVnaW4gYXMgSUZvcmdlUGx1Z2luKS5fX2lzRWxlY3Ryb25Gb3JnZVBsdWdpbikge1xuICAgICAgICByZXR1cm4gcGx1Z2luO1xuICAgICAgfVxuXG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShwbHVnaW4pKSB7XG4gICAgICAgIGNvbnN0IFtwbHVnaW5OYW1lLCBvcHRzID0ge31dID0gcGx1Z2luO1xuICAgICAgICBpZiAodHlwZW9mIHBsdWdpbk5hbWUgIT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBwbHVnaW5bMF0gdG8gYmUgYSBzdHJpbmcgYnV0IGZvdW5kICR7cGx1Z2luTmFtZX1gKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBQbHVnaW4gPSByZXF1aXJlU2VhcmNoPGFueT4oZGlyLCBbcGx1Z2luTmFtZV0pO1xuICAgICAgICBpZiAoIVBsdWdpbikge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGZpbmQgbW9kdWxlIHdpdGggbmFtZTogJHtwbHVnaW5bMF19LiBNYWtlIHN1cmUgaXQncyBsaXN0ZWQgaW4gdGhlIGRldkRlcGVuZGVuY2llcyBvZiB5b3VyIHBhY2thZ2UuanNvbmApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBuZXcgUGx1Z2luKG9wdHMpO1xuICAgICAgfVxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBwbHVnaW4gdG8gZWl0aGVyIGJlIGEgcGx1Z2luIGluc3RhbmNlIG9yIFtzdHJpbmcsIG9iamVjdF0gYnV0IGZvdW5kICR7cGx1Z2lufWApO1xuICAgIH0pO1xuICAgIC8vIEZpeCBsaW50aW5nXG4gICAgdGhpcy5jb25maWcgPSBudWxsIGFzIGFueTtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgJ2NvbmZpZycsIHtcbiAgICAgIHZhbHVlOiBmb3JnZUNvbmZpZyxcbiAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxuICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSxcbiAgICAgIHdyaXRhYmxlOiBmYWxzZSxcbiAgICB9KTtcblxuICAgIGZvciAoY29uc3QgcGx1Z2luIG9mIHRoaXMucGx1Z2lucykge1xuICAgICAgcGx1Z2luLmluaXQoZGlyLCBmb3JnZUNvbmZpZyk7XG4gICAgfVxuXG4gICAgdGhpcy50cmlnZ2VySG9vayA9IHRoaXMudHJpZ2dlckhvb2suYmluZCh0aGlzKTtcbiAgICB0aGlzLm92ZXJyaWRlU3RhcnRMb2dpYyA9IHRoaXMub3ZlcnJpZGVTdGFydExvZ2ljLmJpbmQodGhpcyk7XG4gIH1cblxuICBhc3luYyB0cmlnZ2VySG9vayhob29rTmFtZTogc3RyaW5nLCBob29rQXJnczogYW55W10pIHtcbiAgICBmb3IgKGNvbnN0IHBsdWdpbiBvZiB0aGlzLnBsdWdpbnMpIHtcbiAgICAgIGlmICh0eXBlb2YgcGx1Z2luLmdldEhvb2sgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgY29uc3QgaG9vayA9IHBsdWdpbi5nZXRIb29rKGhvb2tOYW1lKTtcbiAgICAgICAgaWYgKGhvb2spIGF3YWl0IGhvb2sodGhpcy5jb25maWcsIC4uLmhvb2tBcmdzKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyB0cmlnZ2VyTXV0YXRpbmdIb29rPFQ+KGhvb2tOYW1lOiBzdHJpbmcsIGl0ZW06IFQpIHtcbiAgICBmb3IgKGNvbnN0IHBsdWdpbiBvZiB0aGlzLnBsdWdpbnMpIHtcbiAgICAgIGlmICh0eXBlb2YgcGx1Z2luLmdldEhvb2sgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgY29uc3QgaG9vayA9IHBsdWdpbi5nZXRIb29rKGhvb2tOYW1lKTtcbiAgICAgICAgaWYgKGhvb2spIHtcbiAgICAgICAgICBpdGVtID0gYXdhaXQgaG9vayh0aGlzLmNvbmZpZywgaXRlbSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGl0ZW07XG4gIH1cblxuICBhc3luYyBvdmVycmlkZVN0YXJ0TG9naWMob3B0czogU3RhcnRPcHRpb25zKSB7XG4gICAgbGV0IG5ld1N0YXJ0Rm47XG4gICAgY29uc3QgY2xhaW1lZCA9IFtdO1xuICAgIGZvciAoY29uc3QgcGx1Z2luIG9mIHRoaXMucGx1Z2lucykge1xuICAgICAgaWYgKHR5cGVvZiBwbHVnaW4uc3RhcnRMb2dpYyA9PT0gJ2Z1bmN0aW9uJyAmJiBwbHVnaW4uc3RhcnRMb2dpYyAhPT0gUGx1Z2luQmFzZS5wcm90b3R5cGUuc3RhcnRMb2dpYykge1xuICAgICAgICBjbGFpbWVkLnB1c2gocGx1Z2luLm5hbWUpO1xuICAgICAgICBuZXdTdGFydEZuID0gcGx1Z2luLnN0YXJ0TG9naWM7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChjbGFpbWVkLmxlbmd0aCA+IDEpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTXVsdGlwbGUgcGx1Z2lucyB0cmllZCB0byB0YWtlIGNvbnRyb2wgb2YgdGhlIHN0YXJ0IGNvbW1hbmQsIHBsZWFzZSByZW1vdmUgb25lIG9mIHRoZW1cXG4gLS0+ICR7Y2xhaW1lZC5qb2luKCcsICcpfWApO1xuICAgIH1cbiAgICBpZiAoY2xhaW1lZC5sZW5ndGggPT09IDEgJiYgbmV3U3RhcnRGbikge1xuICAgICAgZChgcGx1Z2luOiBcIiR7Y2xhaW1lZFswXX1cIiBoYXMgdGFrZW4gY29udHJvbCBvZiB0aGUgc3RhcnQgY29tbWFuZGApO1xuICAgICAgcmV0dXJuIG5ld1N0YXJ0Rm4ob3B0cyk7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuIl19